-- ================================================
-- ЛОГИСТИЧЕСКАЯ СИСТЕМА - ФИНАЛЬНАЯ СХЕМА БД
-- ================================================
-- Версия: 4.0 FINAL (с учётом ВСЕХ замечаний)
-- Дата: 17.10.2025
-- ================================================
-- Готово к production развёртыванию
-- ================================================

BEGIN;

-- ================================================
-- СОЗДАНИЕ СХЕМ ДЛЯ МИКРОСЕРВИСОВ
-- ================================================

CREATE SCHEMA IF NOT EXISTS user_management;
CREATE SCHEMA IF NOT EXISTS waybill_service;
CREATE SCHEMA IF NOT EXISTS payment_service;
CREATE SCHEMA IF NOT EXISTS delivery_service;
CREATE SCHEMA IF NOT EXISTS warehouse_service;
CREATE SCHEMA IF NOT EXISTS hr_service;
CREATE SCHEMA IF NOT EXISTS notification_service;
CREATE SCHEMA IF NOT EXISTS rating_service;
CREATE SCHEMA IF NOT EXISTS shared_data;
CREATE SCHEMA IF NOT EXISTS archive;

-- ================================================
-- СХЕМА: user_management (User Management Service)
-- ================================================

-- Единая таблица пользователей (авторизованных и неавторизованных)
CREATE TABLE user_management.users (
    user_id BIGSERIAL PRIMARY KEY,
    email VARCHAR(255),
    phone VARCHAR(20) NOT NULL UNIQUE,
    password_hash VARCHAR(255),
    first_name VARCHAR(100) NOT NULL,
    last_name VARCHAR(100) NOT NULL,
    middle_name VARCHAR(100),
    role_name VARCHAR(50) NOT NULL DEFAULT 'UNREGISTERED_CONTACT',
    facility_id BIGINT,
    user_status VARCHAR(20) DEFAULT 'ACTIVE',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_accessed_at TIMESTAMP,
    
    CONSTRAINT check_role_name CHECK (
        role_name IN (
            'UNREGISTERED_CONTACT',
            'CLIENT', 
            'PVZ_OPERATOR', 
            'PVZ_ADMIN', 
            'COURIER', 
            'DRIVER', 
            'DISPATCHER',
            'WAREHOUSE_OPERATOR',
            'WAREHOUSE_ADMIN',
            'HR',
            'ACCOUNTANT',
            'SYSTEM_ADMIN'
        )
    ),
    CONSTRAINT check_auth_data CHECK (
        (role_name = 'UNREGISTERED_CONTACT' AND password_hash IS NULL)
        OR
        (role_name != 'UNREGISTERED_CONTACT' AND password_hash IS NOT NULL AND email IS NOT NULL)
    )
);

COMMENT ON TABLE user_management.users IS 'Единый реестр всех пользователей системы, включая неавторизованных получателей';
COMMENT ON COLUMN user_management.users.role_name IS 'UNREGISTERED_CONTACT - неавторизованный получатель/отправитель без пароля';
COMMENT ON COLUMN user_management.users.last_accessed_at IS 'Последнее посещение системы (только здесь, не дублируется в sessions)';

-- Сессии пользователей (без last_accessed_at)
CREATE TABLE user_management.user_sessions (
    session_id BIGSERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES user_management.users(user_id) ON DELETE CASCADE,
    session_token VARCHAR(255) NOT NULL UNIQUE,
    expires_at TIMESTAMP NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    ip_address INET,
    user_agent TEXT
);

-- Журнал аудита (без old_values, но с record_id)
CREATE TABLE user_management.audit_logs (
    audit_log_id BIGSERIAL PRIMARY KEY,
    user_id BIGINT,
    action VARCHAR(100) NOT NULL,
    table_name VARCHAR(100),
    record_id BIGINT,
    new_values JSONB,
    performed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    ip_address INET
);

COMMENT ON COLUMN user_management.audit_logs.record_id IS 'ID изменённой записи в связке с table_name';
COMMENT ON COLUMN user_management.audit_logs.new_values IS 'Новые значения полей (old_values убраны для упрощения)';

-- ================================================
-- СХЕМА: waybill_service (Waybill Service)
-- ================================================

-- Черновики накладных (со ссылками на users)
CREATE TABLE waybill_service.waybill_drafts (
    draft_id BIGSERIAL PRIMARY KEY,
    barcode VARCHAR(50) UNIQUE NOT NULL,
    draft_creator_id BIGINT NOT NULL,
    sender_user_id BIGINT NOT NULL,
    recipient_user_id BIGINT NOT NULL,
    recipient_address TEXT NOT NULL,
    weight_declared DECIMAL(8,2),
    dimensions_declared VARCHAR(50),
    estimated_price DECIMAL(10,2),
    draft_status VARCHAR(30) DEFAULT 'PENDING',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT check_draft_status CHECK (
        draft_status IN ('PENDING', 'CONFIRMED', 'CANCELLED')
    )
);

COMMENT ON TABLE waybill_service.waybill_drafts IS 'Черновики накладных со ссылками на users вместо текстовых контактов';
COMMENT ON COLUMN waybill_service.waybill_drafts.sender_user_id IS 'ID отправителя (может быть UNREGISTERED_CONTACT)';
COMMENT ON COLUMN waybill_service.waybill_drafts.recipient_user_id IS 'ID получателя (может быть UNREGISTERED_CONTACT)';

-- Готовые накладные (без контактных данных)
CREATE TABLE waybill_service.waybills (
    waybill_id BIGSERIAL PRIMARY KEY,
    waybill_number VARCHAR(50) UNIQUE NOT NULL,
    waybill_creator_id BIGINT NOT NULL,
    sender_user_id BIGINT NOT NULL,
    recipient_user_id BIGINT NOT NULL,
    recipient_address TEXT NOT NULL,
    weight_actual DECIMAL(8,2) NOT NULL,
    dimensions_actual VARCHAR(50),
    final_price DECIMAL(10,2) NOT NULL,
    waybill_status VARCHAR(50) DEFAULT 'ACCEPTED_AT_PVZ',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    accepted_at TIMESTAMP
);

COMMENT ON COLUMN waybill_service.waybills.waybill_creator_id IS 'Оператор ПВЗ, который подтвердил и создал накладную';
COMMENT ON COLUMN waybill_service.waybills.sender_user_id IS 'ID отправителя (ссылка на users)';
COMMENT ON COLUMN waybill_service.waybills.recipient_user_id IS 'ID получателя (ссылка на users)';

-- История статусов накладных
CREATE TABLE waybill_service.waybill_status_history (
    history_id BIGSERIAL PRIMARY KEY,
    waybill_id BIGINT REFERENCES waybill_service.waybills(waybill_id) ON DELETE CASCADE,
    status VARCHAR(50) NOT NULL,
    facility_id BIGINT,
    notes TEXT,
    changed_by BIGINT,
    changed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ================================================
-- СХЕМА: payment_service (Payment Service)
-- ================================================

-- Платежи (без CARD_ONLINE)
CREATE TABLE payment_service.payments (
    payment_id BIGSERIAL PRIMARY KEY,
    waybill_id BIGINT NOT NULL,
    amount DECIMAL(12,2) NOT NULL,
    payment_method VARCHAR(20),
    transaction_id VARCHAR(100),
    payment_status VARCHAR(20) DEFAULT 'PENDING',
    processed_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT check_payment_method CHECK (
        payment_method IN ('CASH', 'CARD_TERMINAL', 'SBP')
    )
);

COMMENT ON CONSTRAINT check_payment_method ON payment_service.payments IS 'CARD_ONLINE удалён - нет онлайн-эквайринга';

-- Чеки
CREATE TABLE payment_service.receipts (
    receipt_id BIGSERIAL PRIMARY KEY,
    payment_id BIGINT REFERENCES payment_service.payments(payment_id) ON DELETE CASCADE,
    receipt_number VARCHAR(50) NOT NULL,
    receipt_data JSONB,
    printed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Возвраты
CREATE TABLE payment_service.refunds (
    refund_id BIGSERIAL PRIMARY KEY,
    payment_id BIGINT REFERENCES payment_service.payments(payment_id),
    amount DECIMAL(12,2) NOT NULL,
    reason VARCHAR(100) NOT NULL,
    refund_status VARCHAR(20) DEFAULT 'PENDING',
    requested_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    approved_at TIMESTAMP,
    completed_at TIMESTAMP,
    
    CONSTRAINT check_refund_reason CHECK (
        reason IN ('DAMAGED', 'WRONG_ADDRESS', 'CANCELLED_BY_CLIENT', 'LOST', 'OTHER')
    )
);

-- ================================================
-- СХЕМА: delivery_service (Delivery Service)
-- ================================================

-- Маршруты курьеров
CREATE TABLE delivery_service.courier_routes (
    courier_route_id BIGSERIAL PRIMARY KEY,
    route_name VARCHAR(100) NOT NULL,
    driver_id BIGINT,
    route_status VARCHAR(30) DEFAULT 'PLANNED',
    planned_start_time TIMESTAMP,
    actual_start_time TIMESTAMP,
    planned_end_time TIMESTAMP,
    actual_end_time TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Точки маршрута (с PARTIALLY_COMPLETED)
CREATE TABLE delivery_service.route_points (
    route_point_id BIGSERIAL PRIMARY KEY,
    courier_route_id BIGINT REFERENCES delivery_service.courier_routes(courier_route_id) ON DELETE CASCADE,
    point_order INTEGER NOT NULL,
    point_type VARCHAR(30) NOT NULL,
    custom_address TEXT,
    latitude DECIMAL(10,7),
    longitude DECIMAL(10,7),
    point_status VARCHAR(30) DEFAULT 'PENDING',
    estimated_arrival TIMESTAMP,
    actual_arrival TIMESTAMP,
    notes TEXT,
    
    CONSTRAINT unique_point_order UNIQUE(courier_route_id, point_order),
    CONSTRAINT check_point_type CHECK (point_type IN ('PICKUP', 'DELIVERY', 'WAREHOUSE')),
    CONSTRAINT check_point_status CHECK (
        point_status IN ('PENDING', 'IN_PROGRESS', 'PARTIALLY_COMPLETED', 'COMPLETED', 'SKIPPED')
    )
);

COMMENT ON COLUMN delivery_service.route_points.point_status IS 'PARTIALLY_COMPLETED - доставлена только часть посылок в точке';
COMMENT ON COLUMN delivery_service.route_points.custom_address IS 'Только для служебных точек (склады, ПВЗ). Адреса клиентов из users';

-- Связь точек маршрута с накладными
CREATE TABLE delivery_service.route_waybills (
    route_waybill_id BIGSERIAL PRIMARY KEY,
    route_point_id BIGINT REFERENCES delivery_service.route_points(route_point_id) ON DELETE CASCADE,
    waybill_id BIGINT NOT NULL,
    is_delivered BOOLEAN DEFAULT FALSE,
    delivered_at TIMESTAMP,
    UNIQUE(route_point_id, waybill_id)
);

-- Завершённые маршруты с GPS-треком
CREATE TABLE delivery_service.completed_routes (
    completed_route_id BIGSERIAL PRIMARY KEY,
    courier_route_id BIGINT NOT NULL,
    driver_id BIGINT NOT NULL,
    route_path JSONB NOT NULL,
    total_distance_km DECIMAL(8,2),
    completed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ================================================
-- СХЕМА: warehouse_service (Warehouse Service)
-- ================================================

-- Складские запасы (с arrived_at)
CREATE TABLE warehouse_service.warehouse_inventory (
    inventory_id BIGSERIAL PRIMARY KEY,
    waybill_id BIGINT,
    facility_id BIGINT NOT NULL,
    inventory_status VARCHAR(30) NOT NULL,
    arrived_at TIMESTAMP,
    departed_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

COMMENT ON COLUMN warehouse_service.warehouse_inventory.arrived_at IS 'Время прибытия на склад';

-- Грузовые перевозки (с route_path для GPS-отслеживания)
CREATE TABLE warehouse_service.cargo_shipments (
    cargo_shipment_id BIGSERIAL PRIMARY KEY,
    shipment_number VARCHAR(50) UNIQUE NOT NULL,
    from_facility_id BIGINT NOT NULL,
    to_facility_id BIGINT NOT NULL,
    vehicle_id BIGINT,
    driver_id BIGINT,
    shipment_status VARCHAR(30) DEFAULT 'PLANNED',
    planned_departure TIMESTAMP,
    actual_departure TIMESTAMP,
    planned_arrival TIMESTAMP,
    actual_arrival TIMESTAMP,
    route_path JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

COMMENT ON COLUMN warehouse_service.cargo_shipments.route_path IS 'GPS-трек грузовика (заполняется при статусе COMPLETED)';
COMMENT ON COLUMN warehouse_service.cargo_shipments.from_facility_id IS 'Может быть склад или ПВЗ';
COMMENT ON COLUMN warehouse_service.cargo_shipments.to_facility_id IS 'Может быть склад или ПВЗ';

-- Элементы грузовых перевозок
CREATE TABLE warehouse_service.cargo_shipment_items (
    shipment_item_id BIGSERIAL PRIMARY KEY,
    cargo_shipment_id BIGINT REFERENCES warehouse_service.cargo_shipments(cargo_shipment_id) ON DELETE CASCADE,
    waybill_id BIGINT NOT NULL,
    loaded_at TIMESTAMP,
    unloaded_at TIMESTAMP
);

-- ================================================
-- СХЕМА: hr_service (HR Service)
-- ================================================

-- Справочник должностей с региональными окладами (БЕЗ experience в employees)
CREATE TABLE hr_service.positions (
    position_id BIGSERIAL PRIMARY KEY,
    position_name VARCHAR(100) NOT NULL,
    role_name VARCHAR(50) NOT NULL,
    region VARCHAR(100) NOT NULL,
    base_salary DECIMAL(12,2) NOT NULL,
    experience_bonus_percent DECIMAL(5,2) NOT NULL DEFAULT 5.00,
    max_experience_years INTEGER DEFAULT 10,
    UNIQUE(position_name, region)
);

COMMENT ON COLUMN hr_service.positions.experience_bonus_percent IS 'Процент надбавки за каждый год опыта';
COMMENT ON COLUMN hr_service.positions.max_experience_years IS 'Максимум лет для расчёта надбавки';

-- Сотрудники (БЕЗ experience_years и experience_bonus)
CREATE TABLE hr_service.employees (
    employee_id BIGSERIAL PRIMARY KEY,
    user_id BIGINT,
    employee_number VARCHAR(20) UNIQUE NOT NULL,
    position_id BIGINT REFERENCES hr_service.positions(position_id),
    employment_status VARCHAR(30) DEFAULT 'ACTIVE',
    hire_date DATE NOT NULL,
    termination_date DATE
);

COMMENT ON TABLE hr_service.employees IS 'Поля experience_years и experience_bonus удалены - зарплата рассчитывается динамически';

-- SQL-функция для динамического расчёта зарплаты
CREATE OR REPLACE FUNCTION calculate_employee_salary(emp_id BIGINT) 
RETURNS DECIMAL(12,2) AS $$
DECLARE
    years_worked INTEGER;
    pos_record RECORD;
    final_salary DECIMAL(12,2);
BEGIN
    SELECT 
        EXTRACT(YEAR FROM AGE(CURRENT_DATE, e.hire_date))::INTEGER AS years,
        p.base_salary,
        p.experience_bonus_percent,
        p.max_experience_years
    INTO pos_record
    FROM hr_service.employees e
    JOIN hr_service.positions p ON e.position_id = p.position_id
    WHERE e.employee_id = emp_id;
    
    years_worked := LEAST(pos_record.years, pos_record.max_experience_years);
    
    final_salary := pos_record.base_salary * 
        (1 + (years_worked * pos_record.experience_bonus_percent / 100));
    
    RETURN final_salary;
END;
$$ LANGUAGE plpgsql;

COMMENT ON FUNCTION calculate_employee_salary(BIGINT) IS 'Динамический расчёт зарплаты на основе опыта и параметров должности';

-- Выплаты сотрудникам
CREATE TABLE hr_service.employee_payments (
    payment_id BIGSERIAL PRIMARY KEY,
    employee_id BIGINT REFERENCES hr_service.employees(employee_id),
    payment_type VARCHAR(30) NOT NULL,
    period_start DATE,
    period_end DATE,
    amount DECIMAL(12,2) NOT NULL,
    description TEXT,
    payment_status VARCHAR(20) DEFAULT 'PENDING',
    paid_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ================================================
-- СХЕМА: notification_service (Notification Service)
-- ================================================

-- Каналы уведомлений (упрощённая версия)
CREATE TABLE notification_service.notification_channels (
    channel_id BIGSERIAL PRIMARY KEY,
    channel_name VARCHAR(20) NOT NULL UNIQUE,
    is_active BOOLEAN DEFAULT TRUE,
    description TEXT
);

COMMENT ON TABLE notification_service.notification_channels IS 'Упрощённая таблица для глобального управления каналами';

-- Шаблоны уведомлений
CREATE TABLE notification_service.notification_templates (
    template_id BIGSERIAL PRIMARY KEY,
    template_name VARCHAR(100) NOT NULL,
    channel_id BIGINT REFERENCES notification_service.notification_channels(channel_id),
    subject VARCHAR(255),
    body_template TEXT NOT NULL,
    max_attempts INTEGER DEFAULT 3,
    effective_from DATE,
    effective_to DATE
);

-- Очередь отправки уведомлений
CREATE TABLE notification_service.notification_queue (
    notification_id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,
    channel_id BIGINT REFERENCES notification_service.notification_channels(channel_id),
    subject VARCHAR(255),
    body TEXT NOT NULL,
    notification_status VARCHAR(20) DEFAULT 'PENDING',
    attempt_number INTEGER DEFAULT 0,
    scheduled_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    sent_at TIMESTAMP,
    error_message TEXT
);

-- Настройки уведомлений пользователей
CREATE TABLE notification_service.user_notification_channels (
    preference_id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,
    channel_id BIGINT REFERENCES notification_service.notification_channels(channel_id),
    is_enabled BOOLEAN DEFAULT TRUE,
    UNIQUE(user_id, channel_id)
);

-- ================================================
-- СХЕМА: rating_service (Rating Service)
-- ================================================

-- Рейтинги и отзывы
CREATE TABLE rating_service.ratings_reviews (
    review_id BIGSERIAL PRIMARY KEY,
    waybill_id BIGINT,
    user_id BIGINT,
    rating INTEGER CHECK (rating BETWEEN 1 AND 5),
    review_text TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ================================================
-- СХЕМА: shared_data (Общие справочники)
-- ================================================

-- Служебные здания
CREATE TABLE shared_data.company_facilities (
    facility_id BIGSERIAL PRIMARY KEY,
    facility_type VARCHAR(20) NOT NULL,
    facility_name VARCHAR(255) NOT NULL,
    address TEXT NOT NULL,
    latitude DECIMAL(10,7),
    longitude DECIMAL(10,7),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    closed_date DATE,
    
    CONSTRAINT check_facility_type CHECK (
        facility_type IN ('PVZ', 'WAREHOUSE', 'OFFICE')
    )
);

-- Правила ценообразования
CREATE TABLE shared_data.pricing_rules (
    pricing_rule_id BIGSERIAL PRIMARY KEY,
    rule_name VARCHAR(100) NOT NULL,
    from_facility_type VARCHAR(20),
    to_facility_type VARCHAR(20),
    weight_min DECIMAL(8,2),
    weight_max DECIMAL(8,2),
    base_price DECIMAL(10,2) NOT NULL,
    price_per_kg DECIMAL(10,2),
    effective_from DATE,
    effective_to DATE
);

-- Транспортные средства
CREATE TABLE shared_data.vehicles (
    vehicle_id BIGSERIAL PRIMARY KEY,
    license_plate VARCHAR(20) UNIQUE NOT NULL,
    capacity_kg DECIMAL(8,2),
    capacity_m3 DECIMAL(8,2),
    vehicle_status VARCHAR(20) DEFAULT 'ACTIVE',
    assigned_facility_id BIGINT REFERENCES shared_data.company_facilities(facility_id)
);

-- Системные настройки
CREATE TABLE shared_data.system_settings (
    setting_key VARCHAR(100) PRIMARY KEY,
    setting_value TEXT NOT NULL,
    description TEXT
);

CREATE TABLE shared_data.event_publication (
    id UUID NOT NULL PRIMARY KEY,
    listener_id VARCHAR(512) NOT NULL,
    event_type VARCHAR(512) NOT NULL,
    serialized_event TEXT NOT NULL,
    publication_date TIMESTAMP NOT NULL,
    completion_date TIMESTAMP
);

-- Функция очистки обработанных событий (Spring Modulith)
CREATE OR REPLACE FUNCTION shared_data.cleanup_completed_events()
RETURNS void AS '
BEGIN
    DELETE FROM shared_data.event_publication
    WHERE completion_date IS NOT NULL 
    AND completion_date < NOW() - INTERVAL ''7 days'';
END;
' LANGUAGE plpgsql;

-- ================================================
-- АРХИВНЫЕ ТАБЛИЦЫ (СХЕМА: archive)
-- ================================================

-- Архив пользователей (с phone)
CREATE TABLE archive.users_archive (
    user_id BIGINT PRIMARY KEY,
    email VARCHAR(255),
    phone VARCHAR(20),
    first_name VARCHAR(100) NOT NULL,
    last_name VARCHAR(100) NOT NULL,
    middle_name VARCHAR(100),
    role_name VARCHAR(50) NOT NULL,
    created_at TIMESTAMP,
    archived_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Архив накладных (со ссылками на user_id)
CREATE TABLE archive.waybills_archive (
    waybill_id BIGINT PRIMARY KEY,
    waybill_number VARCHAR(50) NOT NULL,
    waybill_creator_id BIGINT NOT NULL,
    sender_user_id BIGINT NOT NULL,
    recipient_user_id BIGINT NOT NULL,
    recipient_address TEXT NOT NULL,
    final_price DECIMAL(10,2) NOT NULL,
    waybill_status VARCHAR(50) NOT NULL,
    created_at TIMESTAMP NOT NULL,
    accepted_at TIMESTAMP,
    archived_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

COMMENT ON TABLE archive.waybills_archive IS 'Контактные данные заменены на sender_user_id/recipient_user_id';

-- Архив истории статусов (с changed_by и facility_id)
CREATE TABLE archive.waybill_status_history_archive (
    history_id BIGINT PRIMARY KEY,
    waybill_id BIGINT NOT NULL,
    status VARCHAR(50) NOT NULL,
    facility_id BIGINT,
    changed_by BIGINT,
    changed_at TIMESTAMP NOT NULL,
    archived_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

COMMENT ON COLUMN archive.waybill_status_history_archive.changed_by IS 'ID пользователя, изменившего статус';
COMMENT ON COLUMN archive.waybill_status_history_archive.facility_id IS 'ID здания, где произошло изменение';

-- Архив платежей
CREATE TABLE archive.payments_archive (
    payment_id BIGINT PRIMARY KEY,
    waybill_id BIGINT NOT NULL,
    amount DECIMAL(12,2) NOT NULL,
    payment_method VARCHAR(20) NOT NULL,
    payment_status VARCHAR(20) NOT NULL,
    created_at TIMESTAMP NOT NULL,
    processed_at TIMESTAMP
);

-- Архив чеков
CREATE TABLE archive.receipts_archive (
    receipt_id BIGINT PRIMARY KEY,
    payment_id BIGINT NOT NULL,
    receipt_number VARCHAR(50) NOT NULL,
    printed_at TIMESTAMP,
    archived_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Архив возвратов
CREATE TABLE archive.refunds_archive (
    refund_id BIGINT PRIMARY KEY,
    payment_id BIGINT NOT NULL,
    amount DECIMAL(12,2) NOT NULL,
    refund_status VARCHAR(20) NOT NULL,
    requested_at TIMESTAMP NOT NULL,
    completed_at TIMESTAMP
);

-- Архив маршрутов курьеров (с route_path)
CREATE TABLE archive.courier_routes_archive (
    courier_route_id BIGINT PRIMARY KEY,
    route_name VARCHAR(100) NOT NULL,
    driver_id BIGINT NOT NULL,
    route_status VARCHAR(30) NOT NULL,
    route_path JSONB,
    actual_start_time TIMESTAMP,
    actual_end_time TIMESTAMP
);

COMMENT ON COLUMN archive.courier_routes_archive.route_path IS 'GPS-трек завершённого маршрута курьера';

-- Архив складских запасов (с arrived_at)
CREATE TABLE archive.warehouse_inventory_archive (
    inventory_id BIGINT PRIMARY KEY,
    waybill_id BIGINT,
    facility_id BIGINT NOT NULL,
    inventory_status VARCHAR(30) NOT NULL,
    arrived_at TIMESTAMP,
    departed_at TIMESTAMP,
    archived_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Архив грузовых перевозок (с actual_departure и route_path)
CREATE TABLE archive.cargo_shipments_archive (
    cargo_shipment_id BIGINT PRIMARY KEY,
    shipment_number VARCHAR(50) NOT NULL,
    from_facility_id BIGINT NOT NULL,
    to_facility_id BIGINT NOT NULL,
    driver_id BIGINT,
    vehicle_id BIGINT,
    shipment_status VARCHAR(30) NOT NULL,
    created_at TIMESTAMP NOT NULL,
    actual_departure TIMESTAMP,
    actual_arrival TIMESTAMP,
    route_path JSONB
);

COMMENT ON COLUMN archive.cargo_shipments_archive.route_path IS 'GPS-трек грузовой перевозки';
COMMENT ON COLUMN archive.cargo_shipments_archive.actual_departure IS 'Фактическое время отправления';

-- Архив выплат сотрудников
CREATE TABLE archive.employee_payments_archive (
    payment_id BIGINT PRIMARY KEY,
    employee_id BIGINT NOT NULL,
    payment_type VARCHAR(30) NOT NULL,
    amount DECIMAL(12,2) NOT NULL,
    period_start DATE,
    period_end DATE,
    paid_at TIMESTAMP
);

-- Архив сотрудников (БЕЗ archived_at)
CREATE TABLE archive.employees_archive (
    employee_id BIGINT PRIMARY KEY,
    user_id BIGINT,
    employee_number VARCHAR(20) NOT NULL,
    position_id BIGINT,
    hire_date DATE,
    termination_date DATE
);

COMMENT ON TABLE archive.employees_archive IS 'Поле archived_at удалено - достаточно termination_date';

-- Архив служебных зданий (БЕЗ archived_at)
CREATE TABLE archive.company_facilities_archive (
    facility_id BIGINT PRIMARY KEY,
    facility_type VARCHAR(20) NOT NULL,
    facility_name VARCHAR(255) NOT NULL,
    address TEXT NOT NULL,
    created_at TIMESTAMP,
    closed_date DATE
);

COMMENT ON TABLE archive.company_facilities_archive IS 'Поле archived_at удалено - достаточно closed_date';

-- Архив уведомлений
CREATE TABLE archive.notification_queue_archive (
    notification_id BIGINT PRIMARY KEY,
    user_id BIGINT NOT NULL,
    channel_id BIGINT,
    notification_status VARCHAR(20) NOT NULL,
    sent_at TIMESTAMP,
    archived_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Архив аудита (с record_id)
CREATE TABLE archive.audit_logs_archive (
    audit_log_id BIGINT PRIMARY KEY,
    user_id BIGINT,
    action VARCHAR(100) NOT NULL,
    table_name VARCHAR(100),
    record_id BIGINT,
    new_values JSONB,
    performed_at TIMESTAMP,
    archived_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

COMMENT ON COLUMN archive.audit_logs_archive.record_id IS 'ID изменённой записи (критично для восстановления событий)';

-- ================================================
-- ИНДЕКСЫ
-- ================================================

-- User Management
CREATE INDEX idx_users_email ON user_management.users(email);
CREATE INDEX idx_users_phone ON user_management.users(phone);
CREATE INDEX idx_users_role_name ON user_management.users(role_name);
CREATE INDEX idx_users_last_accessed ON user_management.users(last_accessed_at);
CREATE INDEX idx_user_sessions_user_id ON user_management.user_sessions(user_id);
CREATE INDEX idx_audit_logs_performed_at ON user_management.audit_logs(performed_at);
CREATE INDEX idx_audit_logs_user_id ON user_management.audit_logs(user_id);
CREATE INDEX idx_audit_logs_record ON user_management.audit_logs(table_name, record_id);

-- Waybill Service
CREATE INDEX idx_waybill_drafts_creator ON waybill_service.waybill_drafts(draft_creator_id);
CREATE INDEX idx_waybill_drafts_sender ON waybill_service.waybill_drafts(sender_user_id);
CREATE INDEX idx_waybill_drafts_recipient ON waybill_service.waybill_drafts(recipient_user_id);
CREATE INDEX idx_waybills_creator ON waybill_service.waybills(waybill_creator_id);
CREATE INDEX idx_waybills_sender ON waybill_service.waybills(sender_user_id);
CREATE INDEX idx_waybills_recipient ON waybill_service.waybills(recipient_user_id);
CREATE INDEX idx_waybills_number ON waybill_service.waybills(waybill_number);
CREATE INDEX idx_waybills_status ON waybill_service.waybills(waybill_status);
CREATE INDEX idx_waybill_history_waybill_id ON waybill_service.waybill_status_history(waybill_id);

-- Payment Service
CREATE INDEX idx_payments_waybill_id ON payment_service.payments(waybill_id);
CREATE INDEX idx_receipts_payment_id ON payment_service.receipts(payment_id);

-- Delivery Service
CREATE INDEX idx_courier_routes_driver ON delivery_service.courier_routes(driver_id);
CREATE INDEX idx_route_points_route ON delivery_service.route_points(courier_route_id);
CREATE INDEX idx_route_waybills_point ON delivery_service.route_waybills(route_point_id);
CREATE INDEX idx_route_waybills_waybill ON delivery_service.route_waybills(waybill_id);

-- Warehouse Service
CREATE INDEX idx_warehouse_inventory_waybill ON warehouse_service.warehouse_inventory(waybill_id);
CREATE INDEX idx_warehouse_inventory_facility ON warehouse_service.warehouse_inventory(facility_id);
CREATE INDEX idx_cargo_shipments_from_facility ON warehouse_service.cargo_shipments(from_facility_id);
CREATE INDEX idx_cargo_shipments_to_facility ON warehouse_service.cargo_shipments(to_facility_id);
CREATE INDEX idx_cargo_shipments_route_path ON warehouse_service.cargo_shipments USING gin(route_path);

-- HR Service
CREATE INDEX idx_employees_user_id ON hr_service.employees(user_id);
CREATE INDEX idx_employees_position_id ON hr_service.employees(position_id);
CREATE INDEX idx_employee_payments_employee ON hr_service.employee_payments(employee_id);

-- Shared Data
CREATE INDEX idx_company_facilities_type ON shared_data.company_facilities(facility_type);
CREATE INDEX idx_company_facilities_closed_date ON shared_data.company_facilities(closed_date);
CREATE INDEX idx_event_publication_by_completion_date ON shared_data.event_publication(completion_date);

-- Notification Service
CREATE INDEX idx_notification_queue_user ON notification_service.notification_queue(user_id);
CREATE INDEX idx_user_notification_channels_user ON notification_service.user_notification_channels(user_id);

COMMIT;

-- ================================================
-- КОНЕЦ СХЕМЫ
-- ================================================

-- Готово к развёртыванию!
-- Все изменения применены:
-- ✅ Единая система пользователей (UNREGISTERED_CONTACT)
-- ✅ Убраны контактные данные из waybills
-- ✅ Динамический расчёт зарплаты
-- ✅ PARTIALLY_COMPLETED статус
-- ✅ GPS-отслеживание грузовиков (route_path)
-- ✅ Полные данные в архивах
-- ✅ Убраны избыточные archived_at
-- ✅ Убран CARD_ONLINE
