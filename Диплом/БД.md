# Документация по финальной схеме базы данных логистической системы

## Обзор архитектуры

Финальная версия базы данных (v3.0) спроектирована с учётом **всех 22 замечаний** и полностью готова для production-развёртывания микросервисной логистической системы.

**Ключевые особенности:**
- ✅ Единая система пользователей для авторизованных и неавторизованных клиентов
- ✅ Централизованное управление должностями с региональными окладами
- ✅ Оптимизированная логика архивации без дублирования
- ✅ Исключение контактных данных из накладных (нормализация)
- ✅ Гибкая система уведомлений с множественными каналами

**Схемы:**
- `user_management` - управление пользователями и аудит
- `waybill_service` - сервис накладных
- `payment_service` - сервис платежей, чеков и возвратов
- `delivery_service` - сервис доставки с оптимизированной структурой маршрутов
- `warehouse_service` - складская логистика и грузоперевозки
- `hr_service` - кадровый учёт с таблицей должностей
- `notification_service` - система уведомлений
- `rating_service` - рейтинги и отзывы
- `shared_data` - общие справочники
- `archive` - архивная система

---
## Схема: user_management (User Management Service)

### Таблица: users
**Назначение:** Единый реестр всех участников системы (авторизованных и неавторизованных).

**Foreign Keys:**
- `facility_id` → `shared_data.company_facilities.facility_id` (для сотрудников)

**Столбцы:**
- `user_id` (BIGSERIAL) - Уникальный идентификатор пользователя
- `email` (VARCHAR(255)) - Email адрес (опционально для неавторизованных)
- `phone` (VARCHAR(20)) - **Обязательный** уникальный номер телефона
- `password_hash` (VARCHAR(255)) - Пароль (`NULL` для неавторизованных)
- `first_name` (VARCHAR(100)) - Имя
- `last_name` (VARCHAR(100)) - Фамилия
- `middle_name` (VARCHAR(100)) - Отчество
- `role_name` (VARCHAR(50)) - Роль в системе
- `facility_id` (BIGINT) - Привязка к зданию (для сотрудников)
- `user_status` (VARCHAR(20)) - Статус учетной записи (активна/удалена)
- `created_at` (TIMESTAMP) - Дата регистрации
- `last_accessed_at` (TIMESTAMP) - **Последнее посещение системы**

**Роли:**
- `UNREGISTERED_CONTACT` - Неавторизованный получатель/отправитель (без пароля)
- `CLIENT` - Авторизованный клиент
- `PVZ_OPERATOR`, `PVZ_ADMIN` - Сотрудники ПВЗ
- `COURIER`, `DRIVER` - Курьеры и водители
- `DISPATCHER` - Диспетчеры
- `WAREHOUSE_OPERATOR`, `WAREHOUSE_ADMIN` - Складские сотрудники
- `HR`, `ACCOUNTANT`, `SYSTEM_ADMIN` - Административные роли

**Constraints:**
```sql
CONSTRAINT check_auth_data CHECK (
    (role_name = 'UNREGISTERED_CONTACT' AND password_hash IS NULL)
    OR
    (role_name != 'UNREGISTERED_CONTACT' AND password_hash IS NOT NULL AND email IS NOT NULL)
)
```

**Логика работы:**
1. При создании накладной оператор указывает телефон получателя
2. Система ищет пользователя по телефону
3. Если не найден — создаётся новая запись с `role_name = 'UNREGISTERED_CONTACT'`
4. При регистрации меняется роль на `CLIENT` и добавляется пароль

### Таблица: user_sessions
**Назначение:** Управление сессиями авторизованных пользователей.

**Foreign Keys:**
- `user_id` → `user_management.users.user_id` (CASCADE DELETE)

**Столбцы:**
- `session_id` (BIGSERIAL) - Уникальный идентификатор сессии
- `user_id` (BIGINT) - Ссылка на пользователя
- `session_token` (VARCHAR(255)) - JWT токен
- `expires_at` (TIMESTAMP) - Время истечения сессии
- `created_at` (TIMESTAMP) - Время создания
- `ip_address` (INET) - IP адрес
- `user_agent` (TEXT) - Информация о браузере

### Таблица: audit_logs
**Назначение:** Основная таблица для хранения журнала аудита. Фиксирует все значимые бизнес-события в системе, отвечая на вопросы "кто, что, когда и с какими данными сделал". Критически важна для безопасности и расследования инцидентов.

**Foreign Keys:** 
- `user_id` → `user_management.users(user_id)` с поведением `ON DELETE SET NULL`. Это сохраняет запись аудита, даже если связанный пользователь будет удален, но "обезличивает" ее, устанавливая `user_id` в `NULL`. 
- `action_type_id` → `shared_data.audit_action_types(action_type_id)` с поведением `ON DELETE RESTRICT`. Это предотвращает удаление типа действия из справочника, если на него есть ссылки, гарантируя целостность логов.

**Столбцы:**
- `audit_log_id` (BIGSERIAL) - Уникальный идентификатор записи
- `user_id` (BIGINT) - Кто выполнил действие
- `action_type_id` (SMALLINT) - ID типа действия из справочника `audit_action_types`. Обязательное поле. 
- `table_name` (VARCHAR(100)) - Имя таблицы, над которой производилось действие (например, 'waybills'). `NULL`, если действие не связано с таблицей. 
- `record_id` (BIGINT) - ID конкретной записи, которая была изменена. 
- `actor_identifier` (VARCHAR(255)) - Идентификатор для анонимных действий (например, введенный email при неудачном входе). 
- `new_values` (JSONB) - Новые значения измененных полей в формате JSON. Оптимизировано для поиска. 
- `performed_at` (TIMESTAMP WITH TIME ZONE) - Точное время совершения действия с часовым поясом.
- `ip_address` (INET) - IP-адрес, с которого было совершено действие.

**Автоархивация:** Записи старше 90 дней перемещаются в `archive.audit_logs_archive`.

---

## Схема: waybill_service (Waybill Service)

### Таблица: waybill_drafts
**Назначение:** Черновики накладных со ссылками на пользователей.

**Foreign Keys:**
- `draft_creator_id` → `user_management.users.user_id`
- `sender_user_id` → `user_management.users.user_id`
- `recipient_user_id` → `user_management.users.user_id`

**Столбцы:**
- `draft_id` (BIGSERIAL) - Уникальный идентификатор черновика
- `barcode` (VARCHAR(50)) - Штрихкод
- `draft_creator_id` (BIGINT) - ID авторизованного клиента
- `sender_user_id` (BIGINT) - ID отправителя
- `recipient_user_id` (BIGINT) - ID получателя (вместо имени/телефона)
- `recipient_address` (TEXT) - Адрес доставки
- `weight_declared` (DECIMAL(8,2)) - Заявленный вес
- `dimensions_declared` (VARCHAR(50)) - Заявленные размеры
- `estimated_price` (DECIMAL(10,2)) - Предварительная стоимость
- `draft_status` (VARCHAR(30)) - PENDING, CONFIRMED, CANCELLED
- `created_at` (TIMESTAMP) - Дата создания

**Жизненный цикл:**
- `PENDING` → `CONFIRMED` → Создаётся `waybill` → Черновик удаляется
- `PENDING` → `CANCELLED` → Удаляется через 30 дней

### Таблица: waybills
**Назначение:** Готовые накладные после приёма в ПВЗ.

**Foreign Keys:**
- `waybill_creator_id` → `user_management.users.user_id` (оператор ПВЗ)
- `sender_user_id` → `user_management.users.user_id`
- `recipient_user_id` → `user_management.users.user_id`

**Столбцы:**
- `waybill_id` (BIGSERIAL) - Уникальный идентификатор накладной
- `waybill_number` (VARCHAR(50)) - Номер накладной
- `waybill_creator_id` (BIGINT) - **Оператор ПВЗ**, подтвердивший накладную
- `sender_user_id` (BIGINT) - **ID отправителя**
- `recipient_user_id` (BIGINT) - **ID получателя**
- `recipient_address` (TEXT) - Адрес доставки
- `weight_actual` (DECIMAL(8,2)) - Фактический вес
- `dimensions_actual` (VARCHAR(50)) - Фактические размеры
- `final_price` (DECIMAL(10,2)) - **Итоговая стоимость**
- `waybill_status` (VARCHAR(50)) - Текущий статус
- `created_at` (TIMESTAMP) - Дата создания
- `accepted_at` (TIMESTAMP) - Дата приёма в ПВЗ

**Важно:** Контактные данные (имя, телефон, email) получаются через JOIN с `users`.

### Таблица: waybill_status_history
**Назначение:** История изменений статусов накладных.

**Foreign Keys:**
- `waybill_id` → `waybill_service.waybills.waybill_id` (CASCADE DELETE)
- `facility_id` → `shared_data.company_facilities.facility_id`
- `changed_by` → `user_management.users.user_id`

**Столбцы:**
- `history_id` (BIGSERIAL) - Уникальный идентификатор записи
- `waybill_id` (BIGINT) - Ссылка на накладную
- `status` (VARCHAR(50)) - Новый статус
- `facility_id` (BIGINT) - Где произошло изменение
- `notes` (TEXT) - Дополнительные комментарии
- `changed_by` (BIGINT) - Кто изменил статус
- `changed_at` (TIMESTAMP) - Время изменения

**Автоархивация:** Записи старше 14 дней перемещаются в `archive.waybill_status_history_archive`.

---

## Схема: payment_service (Payment Service)

### Таблица: payments
**Назначение:** Все платежи в системе.

**Foreign Keys:**
- `waybill_id` → `waybill_service.waybills.waybill_id`

**Столбцы:**
- `payment_id` (BIGSERIAL) - Уникальный идентификатор платежа
- `waybill_id` (BIGINT) - Ссылка на накладную
- `amount` (DECIMAL(12,2)) - Сумма платежа (может быть частичной)
- `payment_method` (VARCHAR(20)) - Способ оплаты (CASH, CARD_TERMINAL, SBP)
- `transaction_id` (VARCHAR(100)) - ID транзакции
- `payment_status` (VARCHAR(20)) - Статус платежа
- `processed_at` (TIMESTAMP) - Время обработки
- `created_at` (TIMESTAMP) - Время создания

**Важно:** Поле `amount` сохраняется, так как оплата может быть частичной (несколько платежей на одну накладную).

### Таблица: receipts
**Назначение:** Фискальные чеки.

**Foreign Keys:**
- `payment_id` → `payment_service.payments.payment_id` (CASCADE DELETE)

**Столбцы:**
- `receipt_id` (BIGSERIAL) - Уникальный идентификатор чека
- `payment_id` (BIGINT) - Ссылка на платёж
- `receipt_number` (VARCHAR(50)) - Номер чека
- `receipt_data` (JSONB) - Данные чека в JSON формате
- `printed_at` (TIMESTAMP) - Время печати

**Автоархивация:** Чеки старше 30 дней перемещаются в `archive.receipts_archive`.

### Таблица: refunds
**Назначение:** Возвраты с enum причин.

**Foreign Keys:**
- `payment_id` → `payment_service.payments.payment_id`

**Столбцы:**
- `refund_id` (BIGSERIAL) - Уникальный идентификатор возврата
- `payment_id` (BIGINT) - Ссылка на исходный платёж
- `amount` (DECIMAL(12,2)) - Сумма возврата
- `reason` (VARCHAR(100)) - **Причина возврата** (CHECK constraint)
- `refund_status` (VARCHAR(20)) - Статус возврата
- `requested_at` (TIMESTAMP) - Время запроса
- `approved_at` (TIMESTAMP) - Время одобрения
- `completed_at` (TIMESTAMP) - Время фактического возврата

**Причины возврата:**
- `DAMAGED` - повреждена при транспортировке
- `WRONG_ADDRESS` - неверный адрес доставки
- `CANCELLED_BY_CLIENT` - отменено клиентом
- `LOST` - потеряна при доставке
- `OTHER` - другая причина

---

## Схема: delivery_service (Delivery Service)

### Таблица: courier_routes
**Назначение:** Маршруты курьеров.

**Foreign Keys:**
- `driver_id` → `hr_service.employees.employee_id`

**Столбцы:**
- `courier_route_id` (BIGSERIAL) - Уникальный идентификатор маршрута
- `route_name` (VARCHAR(100)) - Название маршрута
- `driver_id` (BIGINT) - ID курьера
- `route_status` (VARCHAR(30)) - Статус маршрута
- `planned_start_time` (TIMESTAMP) - Запланированное время начала
- `actual_start_time` (TIMESTAMP) - Фактическое время начала
- `planned_end_time` (TIMESTAMP) - Запланированное время окончания
- `actual_end_time` (TIMESTAMP) - Фактическое время окончания
- `created_at` (TIMESTAMP) - Время создания маршрута

### Таблица: route_points
**Назначение:** Точки маршрута.

**Foreign Keys:**
- `courier_route_id` → `delivery_service.courier_routes.courier_route_id` (CASCADE DELETE)

**Столбцы:**
- `route_point_id` (BIGSERIAL) - Уникальный идентификатор точки
- `courier_route_id` (BIGINT) - Ссылка на маршрут
- `point_order` (INTEGER) - Очерёдность доставки
- `point_type` (VARCHAR(30)) - PICKUP, DELIVERY, WAREHOUSE
- `custom_address` (TEXT) - Только для служебных точек
- `latitude` (DECIMAL(10,7)) - GPS координаты
- `longitude` (DECIMAL(10,7)) - GPS координаты
- `point_status` (VARCHAR(30)) - PENDING, IN_PROGRESS, PARTIALLY_COMPLETED, COMPLETED, SKIPPED
- `estimated_arrival` (TIMESTAMP) - Примерное время прибытия
- `actual_arrival` (TIMESTAMP) - Фактическое время прибытия
- `notes` (TEXT) - Примечания

**Важно:** Адреса клиентов берутся из `users` через связь в `route_waybills`.

**Важное дополнение:** Статус `PARTIALLY_COMPLETED` используется, когда курьер доставил только часть посылок в точке (например, из 5 посылок доставлено 3, так как 2 клиента не открыли дверь).


### Таблица: route_waybills
**Назначение:** Связь точек маршрута с накладными.

**Foreign Keys:**
- `route_point_id` → `delivery_service.route_points.route_point_id` (CASCADE DELETE)
- `waybill_id` → `waybill_service.waybills.waybill_id`

**Столбцы:**
- `route_waybill_id` (BIGSERIAL) - Уникальный идентификатор связи
- `route_point_id` (BIGINT) - Ссылка на точку маршрута
- `waybill_id` (BIGINT) - Ссылка на накладную
- `is_delivered` (BOOLEAN) - Флаг доставки конкретной посылки
- `delivered_at` (TIMESTAMP) - Время доставки

**Обоснование полей `is_delivered` и `delivered_at`:**
- `route_points.point_status` = статус **всей точки** (все посылки в ней)
- `route_waybills.is_delivered` = статус **конкретной посылки** в точке
- Пример: Курьер приехал на адрес с 5 посылками, доставил 3, 2 клиентов не было дома. `point_status = PARTIALLY_COMPLETED`, но только у 3 посылок `is_delivered = true`.

### Таблица: completed_routes
**Назначение:** Сжатые GPS-данные завершённых маршрутов.

**Foreign Keys:**
- `courier_route_id` → `delivery_service.courier_routes.courier_route_id`
- `driver_id` → `hr_service.employees.employee_id`

**Столбцы:**
- `completed_route_id` (BIGSERIAL) - Уникальный идентификатор
- `courier_route_id` (BIGINT) - Ссылка на маршрут
- `driver_id` (BIGINT) - ID курьера
- `route_path` (JSONB) - Сжатый маршрут: `[{lat, lon, timestamp}]`
- `total_distance_km` (DECIMAL(8,2)) - Общий пройденный путь
- `completed_at` (TIMESTAMP) - Время завершения

---

## Схема: warehouse_service (Warehouse Service)

### Таблица: warehouse_inventory
**Назначение:** Учёт посылок на складах.

**Foreign Keys:**
- `waybill_id` → `waybill_service.waybills.waybill_id`
- `facility_id` → `shared_data.company_facilities.facility_id`

**Столбцы:**
- `inventory_id` (BIGSERIAL) - Уникальный идентификатор записи
- `waybill_id` (BIGINT) - Ссылка на накладную
- `facility_id` (BIGINT) - ID склада
- `inventory_status` (VARCHAR(30)) - Статус на складе
- `arrived_at` (TIMESTAMP) - **Время поступления на склад**
- `departed_at` (TIMESTAMP) - Время отправления со склада
- `created_at` (TIMESTAMP) - Время создания записи

**Автоархивация:** Через 14 дней после доставки заказа.

### Таблица: cargo_shipments
**Назначение:** Грузовые перевозки между складами и ПВЗ.

**Foreign Keys:**
- `from_facility_id` → `shared_data.company_facilities.facility_id`
- `to_facility_id` → `shared_data.company_facilities.facility_id`
- `vehicle_id` → `shared_data.vehicles.vehicle_id`
- `driver_id` → `hr_service.employees.employee_id`

**Столбцы:**
- `cargo_shipment_id` (BIGSERIAL) - Уникальный идентификатор отгрузки
- `shipment_number` (VARCHAR(50)) - Номер для операторов склада
- `from_facility_id` (BIGINT) - **Откуда** (склад или ПВЗ)
- `to_facility_id` (BIGINT) - **Куда** (склад или ПВЗ)
- `vehicle_id` (BIGINT) - Грузовое транспортное средство
- `driver_id` (BIGINT) - Водитель
- `shipment_status` (VARCHAR(30)) - Статус отгрузки
- `planned_departure` (TIMESTAMP) - Плановое время отправления
- `actual_departure` (TIMESTAMP) - Фактическое время отправления
- `planned_arrival` (TIMESTAMP) - Плановое время прибытия
- `actual_arrival` (TIMESTAMP) - Фактическое время прибытия
- `created_at` (TIMESTAMP) - Время создания отгрузки
- `route_path` (JSONB) - GPS-трек грузовой перевозки (заполняется при завершении)


### Таблица: cargo_shipment_items
**Назначение:** Посылки в конкретной грузовой перевозке.

**Foreign Keys:**
- `cargo_shipment_id` → `warehouse_service.cargo_shipments.cargo_shipment_id` (CASCADE DELETE)
- `waybill_id` → `waybill_service.waybills.waybill_id`

**Столбцы:**
- `shipment_item_id` (BIGSERIAL) - Уникальный идентификатор записи
- `cargo_shipment_id` (BIGINT) - Ссылка на отгрузку
- `waybill_id` (BIGINT) - Ссылка на накладную
- `loaded_at` (TIMESTAMP) - Время погрузки
- `unloaded_at` (TIMESTAMP) - Время разгрузки

---

## Схема: hr_service (HR Service)

### Таблица: positions
**Назначение:** Справочник должностей с региональными окладами.

**Foreign Keys:** Нет.

**Столбцы:**
- `position_id` (BIGSERIAL) - Уникальный идентификатор должности
- `position_name` (VARCHAR(100)) - Название должности ("Курьер", "Старший курьер")
- `role_name` (VARCHAR(50)) - Роль в системе (COURIER, PVZ_OPERATOR)
- `region` (VARCHAR(100)) - Регион ("Москва", "Санкт-Петербург")
- `base_salary` (DECIMAL(12,2)) - Базовый оклад для региона
- `experience_bonus_percent` (DECIMAL(5,2)) - Процент надбавки за каждый год опыта (по умолчанию 5%)
- `max_experience_years` (INTEGER) - Максимальное количество лет для расчёта надбавки (по умолчанию 10)

**Unique constraint:** `UNIQUE(position_name, region)`

### Таблица: employees
**Назначение:** Учёт сотрудников с автоматической надбавкой за опыт.

**Foreign Keys:**
- `user_id` → `user_management.users.user_id`
- `position_id` → `hr_service.positions.position_id`

**Столбцы:**
- `employee_id` (BIGSERIAL) - Уникальный идентификатор сотрудника
- `user_id` (BIGINT) - Ссылка на пользователя
- `employee_number` (VARCHAR(20)) - Табельный номер
- `position_id` (BIGINT) - **Ссылка на должность**
- `employment_status` (VARCHAR(30)) - Статус трудоустройства
- `hire_date` (DATE) - Дата приёма на работу
- `termination_date` (DATE) - Дата увольнения


**Автоархивация:** Через 1 день после увольнения.

### Таблица: employee_payments
**Назначение:** Выплаты сотрудникам.

**Foreign Keys:**
- `employee_id` → `hr_service.employees.employee_id`

**Столбцы:**
- `payment_id` (BIGSERIAL) - Уникальный идентификатор выплаты
- `employee_id` (BIGINT) - Ссылка на сотрудника
- `payment_type` (VARCHAR(30)) - SALARY, BONUS, PER_DELIVERY
- `period_start` (DATE) - Начало периода
- `period_end` (DATE) - Конец периода
- `amount` (DECIMAL(12,2)) - Сумма выплаты
- `description` (TEXT) - Описание выплаты
- `payment_status` (VARCHAR(20)) - Статус выплаты
- `paid_at` (TIMESTAMP) - Время выплаты
- `created_at` (TIMESTAMP) - Время создания

**Автоархивация:** Выплаты старше 3 лет перемещаются в архив.

---

## Схема: notification_service (Notification Service)

### Таблица: notification_channels
**Назначение таблицы:**
1. **Глобальное управление каналами:** Администратор может отключить канал (например, SMS) для всей системы, если провайдер недоступен (`is_active = FALSE`).
2. **Справочник для UI:** Фронтенд запрашивает список активных каналов для отображения в настройках пользователя.
3. **Расширяемость:** Добавление нового канала (например, WhatsApp) не требует изменения кода приложения.

**Упрощённая структура:** Таблица содержит минимум полей для централизованного управления каналами без избыточности.

**Foreign Keys:** Нет.

**Столбцы:**
- `channel_id` (BIGSERIAL) - Уникальный идентификатор канала
- `channel_name` (VARCHAR(20)) - EMAIL, SMS, PUSH
- `is_active` (BOOLEAN) - Активность канала

### Таблица: notification_templates
**Назначение:** Шаблоны уведомлений для каждого канала.

**Foreign Keys:**
- `channel_id` → `notification_service.notification_channels.channel_id`

**Столбцы:**
- `template_id` (BIGSERIAL) - Уникальный идентификатор шаблона
- `template_name` (VARCHAR(100)) - Название шаблона (например, "status_changed")
- `channel_id` (BIGINT) - Канал отправки
- `subject` (VARCHAR(255)) - Тема сообщения (для email)
- `body_template` (TEXT) - Текст с переменными
- `max_attempts` (INTEGER) - Максимальное количество попыток
- `effective_from` (DATE) - Дата начала действия
- `effective_to` (DATE) - Дата окончания действия

**Пример данных:**
```sql
-- Для одного события есть шаблоны под разные каналы
INSERT INTO notification_templates VALUES
(1, 'status_changed', 1, 'Статус вашей посылки изменён', 'Уважаемый {{client_name}}...', 3, NULL, NULL),  -- EMAIL
(2, 'status_changed', 2, NULL, 'Статус {{waybill_number}}: {{status}}', 3, NULL, NULL);  -- SMS (без темы)
```

### Таблица: notification_queue
**Назначение:** Очередь отправки уведомлений.

**Foreign Keys:**
- `user_id` → `user_management.users.user_id`
- `channel_id` → `notification_service.notification_channels.channel_id`

**Столбцы:**
- `notification_id` (BIGSERIAL) - Уникальный идентификатор задачи
- `user_id` (BIGINT) - ID получателя
- `channel_id` (BIGINT) - Канал отправки
- `subject` (VARCHAR(255)) - Тема сообщения
- `body` (TEXT) - Готовый текст сообщения
- `notification_status` (VARCHAR(20)) - Статус отправки
- `attempt_number` (INTEGER) - **Номер текущей попытки**
- `scheduled_at` (TIMESTAMP) - Время запланированной отправки
- `sent_at` (TIMESTAMP) - Время фактической отправки
- `error_message` (TEXT) - Текст ошибки

**Автоархивация:** Отправленные уведомления архивируются через 7 дней.

### Таблица: user_notification_channels
**Назначение:** Настройки пользователей по каналам.

**Foreign Keys:**
- `user_id` → `user_management.users.user_id`
- `channel_id` → `notification_service.notification_channels.channel_id`

**Столбцы:**
- `preference_id` (BIGSERIAL) - Уникальный идентификатор настройки
- `user_id` (BIGINT) - ID пользователя
- `channel_id` (BIGINT) - ID канала
- `is_enabled` (BOOLEAN) - Включён ли канал для пользователя

**Пример:** Пользователь может включить EMAIL и SMS, но отключить PUSH.

**Логика работы:**
1. Пользователь выбирает каналы в настройках
2. При событии система находит все включённые каналы пользователя
3. Для каждого канала находит соответствующий шаблон
4. Создаёт задачи в `notification_queue`

---

## Схема: rating_service (Rating Service)

### Таблица: ratings_reviews
**Назначение:** Рейтинги и отзывы клиентов.

**Foreign Keys:**
- `waybill_id` → `waybill_service.waybills.waybill_id`
- `user_id` → `user_management.users.user_id`

**Столбцы:**
- `review_id` (BIGSERIAL) - Уникальный идентификатор отзыва
- `waybill_id` (BIGINT) - Ссылка на накладную
- `user_id` (BIGINT) - Кто оставил отзыв
- `rating` (INTEGER) - Оценка от 1 до 5
- `review_text` (TEXT) - Текст отзыва
- `created_at` (TIMESTAMP) - Дата создания отзыва

---

## Схема: shared_data (Общие справочники)

### Таблица: company_facilities
**Назначение:** Служебные здания компании.

**Foreign Keys:** Нет.

**Столбцы:**
- `facility_id` (BIGSERIAL) - Уникальный идентификатор здания
- `facility_type` (VARCHAR(20)) - PVZ, WAREHOUSE, OFFICE
- `facility_name` (VARCHAR(255)) - Название здания
- `address` (TEXT) - Полный адрес
- `latitude` (DECIMAL(10,7)) - GPS координаты
- `longitude` (DECIMAL(10,7)) - GPS координаты
- `created_at` (TIMESTAMP) - Дата создания
- `closed_date` (DATE) - Дата закрытия

**Автоудаление:** Закрытые здания удаляются на следующий день после `closed_date`.

### Таблица: pricing_rules
**Назначение:** Правила расчёта стоимости доставки.

**Foreign Keys:** Нет.

**Столбцы:**
- `pricing_rule_id` (BIGSERIAL) - Уникальный идентификатор правила
- `rule_name` (VARCHAR(100)) - Название тарифа
- `from_facility_type` (VARCHAR(20)) - Тип места отправления
- `to_facility_type` (VARCHAR(20)) - Тип места назначения
- `weight_min` (DECIMAL(8,2)) - Минимальный вес
- `weight_max` (DECIMAL(8,2)) - Максимальный вес
- `base_price` (DECIMAL(10,2)) - Базовая стоимость
- `price_per_kg` (DECIMAL(10,2)) - Стоимость за кг
- `effective_from` (DATE) - Дата начала действия
- `effective_to` (DATE) - Дата окончания действия

### Таблица: vehicles
**Назначение:** Справочник транспортных средств (только грузовые).

**Foreign Keys:**
- `assigned_facility_id` → `shared_data.company_facilities.facility_id`

**Столбцы:**
- `vehicle_id` (BIGSERIAL) - Уникальный идентификатор ТС
- `license_plate` (VARCHAR(20)) - Государственный номер
- `capacity_kg` (DECIMAL(8,2)) - Грузоподъёмность в кг
- `capacity_m3` (DECIMAL(8,2)) - Объём в м³
- `vehicle_status` (VARCHAR(20)) - Статус ТС
- `assigned_facility_id` (BIGINT) - Приписанное здание

### Таблица: audit_action_types 
**Назначение:** Справочник всех возможных типов действий, которые могут быть записаны в журнал аудита. Обеспечивает целостность данных и упрощает фильтрацию и анализ логов. Таблица находится в `shared_data`, так как используется всеми сервисами системы. 

**Foreign Keys:** Нет. 

- `action_type_id` (SMALLSERIAL) - Уникальный числовой идентификатор действия (Primary Key). 
- `action_name` (VARCHAR(100)) - Короткое системное имя действия (например, 'USER\_LOGIN\_SUCCESS'). Должно быть уникальным. 
- `category` (VARCHAR(50)) - Категория действия для группировки в UI (например, 'Authentication', 'Payments'). 
- `description` (TEXT) - Человекочитаемое описание действия для отчетов и интерфейса. 

### Таблица: system_settings
**Назначение:** Системные настройки приложения.

**Foreign Keys:** Нет.

**Столбцы:**
- `setting_key` (VARCHAR(100)) - Ключ настройки (PRIMARY KEY)
- `setting_value` (TEXT) - Значение настройки
- `description` (TEXT) - Описание настройки

---

## Схема: archive (Архивные данные)

**Принципы архивной схемы:**
- Только ключевая информация для отчётности
- Минимум дополнительных полей
- Автоматическое архивирование через функции
- **Нет жёстких Foreign Keys** (для независимости)

### Таблица: users_archive
**Назначение:** Архив удалённых пользователей.

**Foreign Keys:** Нет.

**Столбцы:**
- `user_id` (BIGINT) - Уникальный ID пользователя (PRIMARY KEY)
- `email` (VARCHAR(255)) - Email адрес
- `phone` (VARCHAR(20)) - **Номер телефона**
- `first_name` (VARCHAR(100)) - Имя
- `last_name` (VARCHAR(100)) - Фамилия
- `middle_name` (VARCHAR(100)) - Отчество
- `role_name` (VARCHAR(50)) - Роль пользователя
- `created_at` (TIMESTAMP) - Дата регистрации
- `archived_at` (TIMESTAMP) - Дата архивирования

**Когда архивируется:** При удалении учётной записи или через 2 года неактивности (только CLIENT).

### Таблица: waybills_archive
**Назначение:** Архив завершённых накладных.

**Foreign Keys:** Нет.

**Столбцы:**
- `waybill_id` (BIGINT) - Уникальный идентификатор накладной (PRIMARY KEY)
- `waybill_number` (VARCHAR(50)) - Номер накладной
- `waybill_creator_id` (BIGINT) - ID оператора ПВЗ
- `sender_user_id` (BIGINT) - **ID отправителя**
- `recipient_user_id` (BIGINT) - **ID получателя**
- `recipient_address` (TEXT) - Адрес доставки
- `final_price` (DECIMAL(10,2)) - Итоговая стоимость
- `waybill_status` (VARCHAR(50)) - Финальный статус
- `created_at` (TIMESTAMP) - Дата создания
- `accepted_at` (TIMESTAMP) - Дата приёма в ПВЗ
- `archived_at` (TIMESTAMP) - Дата архивирования

**Когда архивируется:** Доставленные/отменённые накладные старше 180 дней.

### Таблица: waybill_status_history_archive
**Назначение:** Архив истории статусов.

**Foreign Keys:** Нет.

**Столбцы:**
- `history_id` (BIGINT) - Уникальный идентификатор записи (PRIMARY KEY)
- `waybill_id` (BIGINT) - ID накладной
- `status` (VARCHAR(50)) - Статус
- `facility_id` (BIGINT) - ID здания, где произошло изменение статуса
- `changed_by` (BIGINT) - ID пользователя, изменившего статус
- `changed_at` (TIMESTAMP) - Время изменения
- `archived_at` (TIMESTAMP) - Дата архивирования


**Когда архивируется:** Записи старше 14 дней.

### Таблица: payments_archive
**Назначение:** Архив платежей.

**Foreign Keys:** Нет.

**Столбцы:**
- `payment_id` (BIGINT) - Уникальный идентификатор платежа (PRIMARY KEY)
- `waybill_id` (BIGINT) - ID накладной
- `amount` (DECIMAL(12,2)) - Сумма платежа
- `payment_method` (VARCHAR(20)) - Способ оплаты
- `payment_status` (VARCHAR(20)) - Финальный статус
- `created_at` (TIMESTAMP) - Дата создания
- `processed_at` (TIMESTAMP) - Дата обработки

### Таблица: receipts_archive
**Назначение:** Архив чеков.

**Foreign Keys:** Нет.

**Столбцы:**
- `receipt_id` (BIGINT) - Уникальный идентификатор чека (PRIMARY KEY)
- `payment_id` (BIGINT) - ID связанного платежа
- `receipt_number` (VARCHAR(50)) - Номер чека
- `printed_at` (TIMESTAMP) - Дата печати
- `archived_at` (TIMESTAMP) - Дата архивирования

**Когда архивируется:** Чеки старше 30 дней.

### Таблица: refunds_archive
**Назначение:** Архив возвратов.

**Foreign Keys:** Нет.

**Столбцы:**
- `refund_id` (BIGINT) - Уникальный идентификатор возврата (PRIMARY KEY)
- `payment_id` (BIGINT) - ID исходного платежа
- `amount` (DECIMAL(12,2)) - Сумма возврата
- `refund_status` (VARCHAR(20)) - Финальный статус
- `requested_at` (TIMESTAMP) - Дата запроса
- `completed_at` (TIMESTAMP) - Дата завершения

### Таблица: courier_routes_archive
**Назначение:** Архив маршрутов курьеров.

**Foreign Keys:** Нет.

**Столбцы:**
- `courier_route_id` (BIGINT) - Уникальный идентификатор маршрута (PRIMARY KEY)
- `route_name` (VARCHAR(100)) - Название маршрута
- `driver_id` (BIGINT) - ID курьера
- `route_status` (VARCHAR(30)) - Финальный статус
- `route_path` (JSONB) - **Сжатый GPS-трек маршрута**
- `actual_start_time` (TIMESTAMP) - Фактическое время начала
- `actual_end_time` (TIMESTAMP) - Фактическое время окончания

**Изменение:** Добавлено поле `route_path`.

### Таблица: warehouse_inventory_archive
**Назначение:** Архив складских запасов.

**Foreign Keys:** Нет.

**Столбцы:**
- `inventory_id` (BIGINT) - Уникальный идентификатор записи (PRIMARY KEY)
- `waybill_id` (BIGINT) - ID накладной
- `facility_id` (BIGINT) - ID склада
- `inventory_status` (VARCHAR(30)) - Статус
- `arrived_at` (TIMESTAMP) - **Время прибытия на склад**
- `departed_at` (TIMESTAMP) - Время отправления со склада
- `archived_at` (TIMESTAMP) - Дата архивирования


**Когда архивируется:** Через 14 дней после доставки соответствующего заказа.

### Таблица: cargo_shipments_archive
**Назначение:** Архив грузовых перевозок.

**Foreign Keys:** Нет.

**Столбцы:**
- `cargo_shipment_id` (BIGINT) - Уникальный идентификатор отгрузки (PRIMARY KEY)
- `shipment_number` (VARCHAR(50)) - Номер отгрузки
- `from_facility_id` (BIGINT) - ID склада/ПВЗ отправления
- `to_facility_id` (BIGINT) - ID склада/ПВЗ назначения
- `driver_id` (BIGINT) - ID водителя
- `shipment_status` (VARCHAR(30)) - Финальный статус
- `created_at` (TIMESTAMP) - Дата создания
- `actual_departure` (TIMESTAMP) - Фактическое время отправления
- `actual_arrival` (TIMESTAMP) - Фактическое время прибытия
- `route_path` (JSONB) - GPS-трек маршрута грузовика (копируется из основной таблицы)

### Таблица: employee_payments_archive
**Назначение:** Архив выплат сотрудникам.

**Foreign Keys:** Нет.

**Столбцы:**
- `payment_id` (BIGINT) - Уникальный идентификатор выплаты (PRIMARY KEY)
- `employee_id` (BIGINT) - ID сотрудника
- `payment_type` (VARCHAR(30)) - Тип выплаты
- `amount` (DECIMAL(12,2)) - Сумма
- `period_start` (DATE) - Начало периода
- `period_end` (DATE) - Конец периода
- `paid_at` (TIMESTAMP) - Дата выплаты

### Таблица: employees_archive
**Назначение:** Архив сотрудников.

**Foreign Keys:** Нет.

**Столбцы:**
- `employee_id` (BIGINT) - Уникальный идентификатор сотрудника (PRIMARY KEY)
- `user_id` (BIGINT) - ID связанного пользователя
- `employee_number` (VARCHAR(20)) - Табельный номер
- `position_id` (BIGINT) - **ID должности**
- `hire_date` (DATE) - Дата приёма на работу
- `termination_date` (DATE) - Дата увольнения

**Когда архивируется:** Через 1 день после даты увольнения.

### Таблица: company_facilities_archive
**Назначение:** Архив закрытых служебных зданий.

**Foreign Keys:** Нет.

**Столбцы:**
- `facility_id` (BIGINT) - Уникальный идентификатор здания (PRIMARY KEY)
- `facility_type` (VARCHAR(20)) - Тип здания
- `facility_name` (VARCHAR(255)) - Название
- `address` (TEXT) - Адрес
- `created_at` (TIMESTAMP) - Дата создания
- `closed_date` (DATE) - Дата закрытия

**Когда архивируется:** На следующий день после даты закрытия.

### Таблица: notification_queue_archive
**Назначение:** Архив уведомлений.

**Foreign Keys:** Нет.

**Столбцы:**
- `notification_id` (BIGINT) - Уникальный идентификатор уведомления (PRIMARY KEY)
- `user_id` (BIGINT) - ID получателя
- `channel_id` (BIGINT) - ID канала
- `notification_status` (VARCHAR(20)) - Финальный статус
- `sent_at` (TIMESTAMP) - Дата отправки
- `archived_at` (TIMESTAMP) - Дата архивирования

**Когда архивируется:** Через 7 дней после отправки.

### Таблица: audit_logs_archive
**Назначение:** Архив аудита.

**Foreign Keys:** Нет.

**Столбцы:**
- `audit_log_id` (BIGINT) - Уникальный идентификатор записи (PRIMARY KEY)
- `user_id` (BIGINT) - ID пользователя
- `action` (VARCHAR(100)) - Тип действия
- `table_name` (VARCHAR(100)) - Название таблицы
- `record_id` (BIGINT) - **ID изменённой записи**
- `new_values` (JSONB) - Новые значения
- `performed_at` (TIMESTAMP) - Время выполнения
- `archived_at` (TIMESTAMP) - Дата архивирования

**Важно:** Поле `record_id` критически важно для идентификации изменённой записи в связке с `table_name`. Например: `table_name = 'waybills'`, `record_id = 12345` означает изменение накладной с ID 12345.


**Когда архивируется:** Записи старше 90 дней.

---

## Функции автоматического архивирования

Все функции выполняются по расписанию через cron:

### 1. auto_archive_inactive_users()
Архивирует клиентов неактивных более 2 лет.

### 2. auto_archive_status_history()
Архивирует историю статусов старше 14 дней.

### 3. auto_archive_receipts()
Архивирует чеки старше 30 дней.

### 4. auto_archive_refunds()
Архивирует завершённые возвраты старше 30 дней.

### 5. auto_archive_inventory()
Архивирует складские запасы через 14 дней после доставки.

### 6. auto_archive_employees()
Архивирует сотрудников через 1 день после увольнения.

### 7. auto_archive_closed_facilities()
Удаляет закрытые здания на следующий день после закрытия.

### 8. auto_archive_notifications()
Архивирует отправленные уведомления через 7 дней.

### 9. auto_archive_audit_logs()
Архивирует логи аудита старше 90 дней.

### 10. delete_cancelled_drafts()
Удаляет отменённые черновики через 30 дней.

---

## Настройка автоматических задач (cron)

```bash
# Ежедневные задачи
0 2 * * * psql -d logistics -c "SELECT auto_archive_status_history();"
0 3 * * * psql -d logistics -c "SELECT auto_archive_refunds();"
0 4 * * * psql -d logistics -c "SELECT auto_archive_receipts();"
0 5 * * * psql -d logistics -c "SELECT auto_archive_inventory();"
0 6 * * * psql -d logistics -c "SELECT auto_archive_employees();"
0 1 * * * psql -d logistics -c "SELECT auto_archive_closed_facilities();"

# Еженедельные задачи
0 2 * * 0 psql -d logistics -c "SELECT auto_archive_notifications();"
0 3 * * 0 psql -d logistics -c "SELECT auto_archive_audit_logs();"
0 4 * * 0 psql -d logistics -c "SELECT delete_cancelled_drafts();"
0 5 * * 0 psql -d logistics -c "SELECT auto_archive_inactive_users();"
```

---

## Ключевые улучшения финальной схемы

### ✅ **Нормализация данных**
- Единая таблица пользователей
- Нет дублирования контактов
- Централизованное управление должностями

### ✅ **Оптимизация архивации**
- Разные сроки для разных типов данных
- Автоматические функции
- Независимость архивов

### ✅ **Гибкость для бизнеса**
- Поддержка неавторизованных получателей
- Региональные оклады
- Частичные платежи

### ✅ **Безопасность**
- Отсутствие паспортных данных
- Журналирование всех действий
- Контроль доступа на уровне ролей

Эта схема полностью готова для production-развёртывания!**Назначение:** Служебные здания компании с системой закрытия.

**Столбцы:**
- `facility_id` (BIGSERIAL) - Уникальный идентификатор здания
- `facility_type` (VARCHAR(20)) - **PVZ, WAREHOUSE, OFFICE** (добавлен OFFICE)
- `facility_name` (VARCHAR(255)) - Название здания
- `address` (TEXT) - Полный адрес
- `latitude` (DECIMAL(10,7)) - GPS координаты для карт
- `longitude` (DECIMAL(10,7)) - GPS координаты для карт
- `created_at` (TIMESTAMP) - Дата создания
- `closed_date` (DATE) - **Дата закрытия** (вместо is_active)

**Автоудаление:** Закрытые здания удаляются на следующий день после `closed_date` функцией `auto_archive_closed_facilities()`.

### Таблица: pricing_rules
**Назначение:** Правила расчёта стоимости доставки.

**Столбцы:**
- `pricing_rule_id` (BIGSERIAL) - Уникальный идентификатор правила
- `rule_name` (VARCHAR(100)) - Название тарифа
- `from_facility_type` (VARCHAR(20)) - Тип места отправления
- `to_facility_type` (VARCHAR(20)) - Тип места назначения
- `weight_min` (DECIMAL(8,2)) - Минимальный вес
- `weight_max` (DECIMAL(8,2)) - Максимальный вес
- `base_price` (DECIMAL(10,2)) - Базовая стоимость
- `price_per_kg` (DECIMAL(10,2)) - Стоимость за кг
- `effective_from` (DATE) - Дата начала действия
- `effective_to` (DATE) - Дата окончания действия

### Таблица: vehicles
**Назначение:** Справочник транспортных средств (только грузовые).

**Foreign Keys:**
- `assigned_facility_id` → `shared_data.company_facilities.facility_id`

**Столбцы:**
- `vehicle_id` (BIGSERIAL) - Уникальный идентификатор ТС
- `license_plate` (VARCHAR(20)) - Государственный номер
- `capacity_kg` (DECIMAL(8,2)) - Грузоподъёмность в кг
- `capacity_m3` (DECIMAL(8,2)) - Объём в м³
- `vehicle_status` (VARCHAR(20)) - Статус ТС
- `assigned_facility_id` (BIGINT) - Приписанное здание

**Упрощение:** Убран `vehicle_type` - все машины грузовые для логистики.

### Таблица: system_settings
**Назначение:** Системные настройки приложения.

**Столбцы:**
- `setting_key` (VARCHAR(100)) - Ключ настройки (PRIMARY KEY)
- `setting_value` (TEXT) - Значение настройки
- `description` (TEXT) - Описание настройки

---
## Схема: archive (Архивные данные)

**Общее назначение:** Долгосрочное хранение исторических данных с упрощённой структурой для отчётности и аналитики. Данные перемещаются сюда из оперативных таблиц с помощью автоматических функций и **не дублируются**.

**Связанные микросервисы:**
- Archive Service (владелец всех архивных таблиц)
- Все остальные сервисы (вызывают функции архивирования)

---

### Таблица: users_archive
**Назначение:** Архив удалённых учётных записей пользователей для соблюдения требований законодательства и внутреннего аудита.

**Foreign Keys:** Нет (архивная таблица без жёстких связей).

**Столбцы:**
- `user_id` (BIGINT) - Уникальный идентификатор пользователя из основной таблицы (PRIMARY KEY).
- `email` (VARCHAR(255)) - Email адрес пользователя для поиска.
- `first_name` (VARCHAR(100)) - Имя пользователя.
- `last_name` (VARCHAR(100)) - Фамилия пользователя.
- `middle_name` (VARCHAR(100)) - Отчество пользователя.
- `role_name` (VARCHAR(50)) - Роль пользователя на момент удаления.
- `created_at` (TIMESTAMP) - Исходная дата регистрации в системе.
- `archived_at` (TIMESTAMP) - Дата и время перемещения в архив.

**Когда архивируется:** При удалении учётной записи пользователя или через 2 года неактивности (только для роли CLIENT).

---

### Таблица: waybill_drafts_archive
**Назначение:** Архив отменённых черновиков накладных для освобождения места в рабочей таблице.

**Foreign Keys:** Нет.

**Столбцы:**
- `draft_id` (BIGINT) - Уникальный идентификатор черновика (PRIMARY KEY).
- `waybill_creator_id` (BIGINT) - ID клиента, создавшего черновик.
- `sender_name` (VARCHAR(255)) - Имя отправителя.
- `recipient_name` (VARCHAR(255)) - Имя получателя.
- `estimated_price` (DECIMAL(10,2)) - Предварительная стоимость доставки.
- `draft_status` (VARCHAR(30)) - Финальный статус черновика (только CANCELLED).
- `created_at` (TIMESTAMP) - Исходная дата создания черновика.
- `archived_at` (TIMESTAMP) - Дата и время перемещения в архив.

**Когда архивируется:** Только отменённые черновики старше 30 дней.

---

### Таблица: waybills_archive
**Назначение:** Архив завершённых накладных для долгосрочного хранения и отчётности.

**Foreign Keys:** Нет.

**Столбцы:**
- `waybill_id` (BIGINT) - Уникальный идентификатор накладной (PRIMARY KEY).
- `waybill_number` (VARCHAR(50)) - Номер накладной для поиска.
- `waybill_creator_id` (BIGINT) - ID авторизованного клиента-создателя.
- `sender_name` (VARCHAR(255)) - Имя фактического отправителя.
- `recipient_name` (VARCHAR(255)) - Имя получателя.
- `recipient_address` (TEXT) - Адрес доставки.
- `final_price` (DECIMAL(10,2)) - Итоговая стоимость (зафиксированная).
- `waybill_status` (VARCHAR(50)) - Финальный статус (DELIVERED, CANCELLED).
- `created_at` (TIMESTAMP) - Исходная дата создания.
- `accepted_at` (TIMESTAMP) - Исходная дата приёма в ПВЗ.
- `archived_at` (TIMESTAMP) - Дата и время перемещения в архив.

**Когда архивируется:** Доставленные/отменённые накладные старше 180 дней.

---

### Таблица: waybill_status_history_archive
**Назначение:** Архив истории изменений статусов накладных для аналитики времени доставки.

**Foreign Keys:** Нет.

**Столбцы:**
- `history_id` (BIGINT) - Уникальный идентификатор записи (PRIMARY KEY).
- `waybill_id` (BIGINT) - ID накладной, к которой относится статус.
- `status` (VARCHAR(50)) - Статус на момент изменения.
- `changed_at` (TIMESTAMP) - Дата и время изменения статуса.
- `archived_at` (TIMESTAMP) - Дата и время перемещения в архив.

**Когда архивируется:** Записи истории старше 14 дней.

---

### Таблица: payments_archive
**Назначение:** Архив завершённых платежей для финансовой и налоговой отчётности.

**Foreign Keys:** Нет.

**Столбцы:**
- `payment_id` (BIGINT) - Уникальный идентификатор платежа (PRIMARY KEY).
- `waybill_id` (BIGINT) - ID накладной, за которую был платёж.
- `amount` (DECIMAL(12,2)) - Сумма платежа.
- `payment_method` (VARCHAR(20)) - Способ оплаты.
- `payment_status` (VARCHAR(20)) - Финальный статус (COMPLETED, FAILED).
- `created_at` (TIMESTAMP) - Исходная дата создания.
- `processed_at` (TIMESTAMP) - Исходная дата обработки.

---

### Таблица: receipts_archive
**Назначение:** Архив фискальных чеков.

**Foreign Keys:** Нет.

**Столбцы:**
- `receipt_id` (BIGINT) - Уникальный идентификатор чека (PRIMARY KEY).
- `payment_id` (BIGINT) - ID связанного платежа.
- `receipt_number` (VARCHAR(50)) - Номер чека.
- `printed_at` (TIMESTAMP) - Исходная дата печати.
- `archived_at` (TIMESTAMP) - Дата и время перемещения в архив.

**Когда архивируется:** Чеки старше 30 дней.

---

### Таблица: refunds_archive
**Назначение:** Архив завершённых возвратов денежных средств.

**Foreign Keys:** Нет.

**Столбцы:**
- `refund_id` (BIGINT) - Уникальный идентификатор возврата (PRIMARY KEY).
- `payment_id` (BIGINT) - ID исходного платежа.
- `amount` (DECIMAL(12,2)) - Сумма возврата.
- `refund_status` (VARCHAR(20)) - Финальный статус (COMPLETED, REJECTED).
- `requested_at` (TIMESTAMP) - Исходная дата запроса.
- `completed_at` (TIMESTAMP) - Исходная дата завершения.

---

### Таблица: courier_routes_archive
**Назначение:** Архив завершённых маршрутов курьеров для анализа эффективности.

**Foreign Keys:** Нет.

**Столбцы:**
- `courier_route_id` (BIGINT) - Уникальный идентификатор маршрута (PRIMARY KEY).
- `route_name` (VARCHAR(100)) - Название маршрута.
- `driver_id` (BIGINT) - ID курьера.
- `route_status` (VARCHAR(30)) - Финальный статус (COMPLETED, CANCELLED).
- `actual_start_time` (TIMESTAMP) - Фактическое время начала.
- `actual_end_time` (TIMESTAMP) - Фактическое время окончания.

---

### Таблица: warehouse_inventory_archive
**Назначение:** Архив складских перемещений посылок.

**Foreign Keys:** Нет.

**Столбцы:**
- `inventory_id` (BIGINT) - Уникальный идентификатор записи (PRIMARY KEY).
- `waybill_id` (BIGINT) - ID накладной.
- `facility_id` (BIGINT) - ID склада.
- `inventory_status` (VARCHAR(30)) - Статус на складе.
- `departed_at` (TIMESTAMP) - Исходное время отправления со склада.
- `archived_at` (TIMESTAMP) - Дата и время перемещения в архив.

**Когда архивируется:** Через 14 дней после доставки соответствующего заказа.

---

### Таблица: cargo_shipments_archive
**Назначение:** Архив завершённых грузовых перевозок между складами.

**Foreign Keys:** Нет.

**Столбцы:**
- `cargo_shipment_id` (BIGINT) - Уникальный идентификатор отгрузки (PRIMARY KEY).
- `shipment_number` (VARCHAR(50)) - Номер отгрузки для поиска.
- `from_facility_id` (BIGINT) - ID склада отправления.
- `to_facility_id` (BIGINT) - ID склада назначения.
- `driver_id` (BIGINT) - ID водителя.
- `shipment_status` (VARCHAR(30)) - Финальный статус.
- `created_at` (TIMESTAMP) - Исходная дата создания.
- `actual_arrival` (TIMESTAMP) - Фактическое время прибытия.

---

### Таблица: employee_payments_archive
**Назначение:** Архив выплат сотрудникам для кадрового и бухгалтерского учёта.

**Foreign Keys:** Нет.

**Столбцы:**
- `payment_id` (BIGINT) - Уникальный идентификатор выплаты (PRIMARY KEY).
- `employee_id` (BIGINT) - ID сотрудника.
- `payment_type` (VARCHAR(30)) - Тип выплаты.
- `amount` (DECIMAL(12,2)) - Сумма.
- `period_start` (DATE) - Начало периода начисления.
- `period_end` (DATE) - Конец периода начисления.
- `paid_at` (TIMESTAMP) - Дата фактической выплаты.

---

### Таблица: employees_archive
**Назна-чение:** Архив уволенных сотрудников.

**Foreign Keys:** Нет.

**Столбцы:**
- `employee_id` (BIGINT) - Уникальный идентификатор сотрудника (PRIMARY KEY).
- `user_id` (BIGINT) - ID связанного пользователя.
- `employee_number` (VARCHAR(20)) - Табельный номер.
- `position` (VARCHAR(100)) - Должность.
- `hire_date` (DATE) - Дата приёма на работу.
- `termination_date` (DATE) - Дата увольнения.
- `archived_at` (TIMESTAMP) - Дата и время перемещения в архив.

**Когда архивируется:** Через 1 день после даты увольнения.

---

### Таблица: company_facilities_archive
**Назначение:** Архив закрытых служебных зданий.

**Foreign Keys:** Нет.

**Столбцы:**
- `facility_id` (BIGINT) - Уникальный идентификатор здания (PRIMARY KEY).
- `facility_type` (VARCHAR(20)) - Тип здания (PVZ, WAREHOUSE, OFFICE).
- `facility_name` (VARCHAR(255)) - Название.
- `address` (TEXT) - Полный адрес.
- `created_at` (TIMESTAMP) - Исходная дата создания.
- `closed_date` (DATE) - Дата закрытия.
- `archived_at` (TIMESTAMP) - Дата и время перемещения в архив.

**Когда архивируется:** На следующий день после даты закрытия.

---

### Таблица: notification_queue_archive
**Назначение:** Архив отправленных уведомлений.

**Foreign Keys:** Нет.

**Столбцы:**
- `notification_id` (BIGINT) - Уникальный идентификатор уведомления (PRIMARY KEY).
- `user_id` (BIGINT) - ID получателя.
- `channel_id` (BIGINT) - ID канала отправки.
- `notification_status` (VARCHAR(20)) - Финальный статус (SENT, FAILED).
- `sent_at` (TIMESTAMP) - Исходная дата отправки.
- `archived_at` (TIMESTAMP) - Дата и время перемещения в архив.

**Когда архивируется:** Через 7 дней после отправки.

---

### Таблица: audit_logs_archive
**Назначение:** Архив старых записей аудита.

**Foreign Keys:** Нет.

**Столбцы:**
- `audit_log_id` (BIGINT) - Уникальный идентификатор записи (PRIMARY KEY).
- `user_id` (BIGINT) - ID пользователя.
- `action` (VARCHAR(100)) - Тип действия.
- `table_name` (VARCHAR(100)) - Название таблицы.
- `performed_at` (TIMESTAMP) - Исходное время выполнения.
- `archived_at` (TIMESTAMP) - Дата и время перемещения в архив.

**Когда архивируется:** Записи старше 90 дней.

## Функции автоматического архивирования

### 1. auto_archive_inactive_users()
Архивирует клиентов неактивных более 2 лет.

### 2. auto_archive_status_history()
Архивирует историю статусов старше 14 дней.

### 3. auto_archive_receipts()
Архивирует чеки старше 30 дней.

### 4. auto_archive_refunds()
Архивирует завершённые возвраты старше 30 дней.

### 5. auto_archive_inventory()
Архивирует складские запасы через 14 дней после доставки.

### 6. auto_archive_employees()
Архивирует сотрудников через 1 день после увольнения.

### 7. auto_archive_closed_facilities()
Удаляет закрытые здания на следующий день после закрытия.

### 8. auto_archive_notifications()
Архивирует отправленные уведомления через 7 дней.

### 9. auto_archive_audit_logs()
Архивирует логи аудита старше 90 дней.

### 10. delete_cancelled_drafts()
Удаляет отменённые черновики через 30 дней.

---

## Поддержка неавторизованных получателей

### Как работает система:

**1. Создание накладной:**
```sql
INSERT INTO waybills (
    waybill_creator_id,    -- 123 (авторизованный клиент)
    recipient_name,        -- "Мария Петрова" (НЕ авторизована!)
    recipient_phone,       -- "+79991234567"
    recipient_address      -- "г. Москва, ул. Ленина, д. 5"
)
```

**2. Отслеживание посылки получателем:**
```java
// Публичный API без авторизации
GET /api/tracking/public/track?waybillNumber=WB-12345&phone=%2B79991234567

// Проверяем совпадение телефона для безопасности
if (!waybill.getRecipientPhone().equals(phone)) {
    throw new ForbiddenException("Неверный телефон получателя");
}
```

**3. Получение посылки в ПВЗ:**
```java
// Оператор сверяет документы получателя с данными в накладной
if (!waybill.getRecipientName().equals(request.getRecipientNameFromId())) {
    throw new ValidationException("Имя получателя не совпадает");
}
```

**Ключевые особенности:**
- ✅ `waybill_creator_id` - ОБЯЗАТЕЛЬНО авторизованный пользователь
- ✅ `recipient_*` поля - простой текст, БЕЗ связи с `users`
- ✅ Безопасность через проверку телефона
- ✅ SMS с уникальными ссылками для отслеживания

---

## Настройка автоматических задач (cron)

```bash
# Ежедневные задачи
0 2 * * * psql -d logistics -c "SELECT auto_archive_status_history();"
0 3 * * * psql -d logistics -c "SELECT auto_archive_refunds();"
0 4 * * * psql -d logistics -c "SELECT auto_archive_receipts();"
0 5 * * * psql -d logistics -c "SELECT auto_archive_inventory();"
0 6 * * * psql -d logistics -c "SELECT auto_archive_employees();"
0 1 * * * psql -d logistics -c "SELECT auto_archive_closed_facilities();"

# Еженедельные задачи
0 2 * * 0 psql -d logistics -c "SELECT auto_archive_notifications();"
0 3 * * 0 psql -d logistics -c "SELECT auto_archive_audit_logs();"
0 4 * * 0 psql -d logistics -c "SELECT delete_cancelled_drafts();"
0 5 * * 0 psql -d logistics -c "SELECT auto_archive_inactive_users();"
```

---