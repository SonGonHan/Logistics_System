## 1. Регистрация и авторизация пользователя

1. Пользователь открывает страницу регистрации или мобильное приложение и заполняет форму регистрации данных учетной записи.
    
2. Отправляется запрос `POST /api/v1/auth/register` для создания учетной записи и получения подтверждения регистрации. 
   - Body: `{"phone_number": "+7...", "email": "user@example.com", "full_name": "ФИ"}`
   - Response: `{"user_id": "uuid", "status": "created"}`
    
3. Выполняется вход: отправляется запрос `POST /api/v1/auth/login`, система возвращает токен авторизации для последующей работы в вебе и приложении.
   - Body: `{"phone_number": "+7...", "password": "***"}`
   - Response: `{"access_token": "jwt_token", "refresh_token": "jwt_token"}`

## 2. Создание черновика накладной

1. Авторизованный пользователь открывает форму и заполняет основные поля, после чего выполняется предварительная калькуляция стоимости и сроков отдельным вызовом `POST /api/v1/pricing/calculate` для подтверждения пользователем перед сохранением черновика.
   - Body: `{"from_city": "Москва", "to_city": "СПб", "weight": 1.5, "dimensions": {...}}`
   - Response: `{"cost": 500, "delivery_days": 3}`
    
2. Сохранение черновика накладной выполняется отдельным запросом `POST /api/v1/waybills/drafts`, система присваивает идентификатор/штрихкод для ускоренной сдачи в ПВЗ и явно фиксирует, что это не фактическая отгрузка.
   - Body: `{"sender": {...}, "recipient": {...}, "items": [...]}`
   - Response: `{"draft_id": "uuid", "barcode": "123456", "status": "draft"}`
    
3. Выбор плательщика и метода оплаты: в черновике указывается, кто платит (отправитель или получатель) и способ оплаты (наличные/карта) отдельным запросом `PUT /api/v1/waybills/drafts/{draft_id}/payment`, изменение выбора до сдачи выполняется отдельным запросом `PUT /api/v1/waybills/drafts/{draft_id}/payment`.
   - Body: `{"payer": "sender", "payment_method": "card"}`
   - Response: `{"draft_id": "uuid", "updated": true}`
    
4. До фактической сдачи черновик доступен для редактирования и отмены отдельными запросами `DELETE /api/v1/waybills/drafts/{draft_id}`, что позволяет корректировать данные до техпроверок в ПВЗ.
   - Response: `{"draft_id": "uuid", "status": "cancelled"}`

## 3. Сдача посылки в ПВЗ по черновику накладной

1. Пользователь приходит в ПВЗ с посылкой и предъявляет штрихкод/ID черновика; оператор ПВЗ находит черновик через `GET /api/v1/waybills/drafts/{barcode}` и инициирует приемку.
   - Response: `{"draft_id": "uuid", "sender": {...}, "recipient": {...}}`
    
2. Оператор выполняет контроль фактического веса/габаритов и фотофиксацию отдельным запросом `PUT /api/v1/acceptance/register/{draft_id}`, после чего система пересчитывает стоимость и сроки.
   - Body: `{"actual_weight": 1.8, "actual_dimensions": {...}, "photo_ids": ["id1","id2"]}`
   - Response: `{"waybill_id": "uuid", "recalculated_cost": 550}`
    
3. Проверка статуса оплаты по черновику выполняется отдельным запросом `GET /api/v1/payments/status/{draft_id}`, чтобы определить дальнейшие действия при оформлении.
   - Response: `{"payer": "sender", "payment_method": "card", "status": "pending"}`
    
4. Если плательщик — отправитель:
    
    - **Карта** — оператор инициирует оплату через эквайринг запросом `POST /api/v1/payments/initiate-card`, при успехе подтверждает платеж запросом `POST /api/v1/payments/confirm/{payment_id}` и печатает чек/квитанцию.
        - Body: `{"waybill_id": "uuid", "amount": 550, "terminal_id": "term123"}`
        - Response: `{"payment_id": "uuid", "status": "completed"}`
        
    - **Наличные** — оператор открывает оплату запросом `POST /api/v1/payments/initiate-cash`, вводит сумму, полученную от отправителя, система рассчитывает сдачу; оператор фиксирует «получено» и «сдано» отдельным запросом `POST /api/v1/payments/finalize-cash/{payment_id}`, затем печатает чек.
        - Body: `{"waybill_id": "uuid", "amount_required": 550}`
        - Response: `{"payment_id": "uuid", "status": "completed", "change": 0}`
        
5. Если плательщик — получатель, оператор завершает оформление без взимания оплаты, устанавливая признак «ожидает оплаты получателем при выдаче» отдельным запросом `PUT /api/v1/waybills/{draft_id}/payment-mode`.
   - Body: `{"mode": "collect_on_delivery"}`
   - Response: `{"draft_id": "uuid", "payment_mode": "cod"}`
    
6. На базе черновика оператор автоматически заполняет поля финальной накладной и предлагает пользователю подтвердить условия; подтверждение фиксируется отдельным запросом `POST /api/v1/waybills/{draft_id}/confirm`.
   - Body: `{"confirmed": true, "signature": "..."}`
   - Response: `{"draft_id": "uuid", "status": "confirmed"}`
    
7. После подтверждения оператор оформляет отправку: запрос `POST /api/v1/waybills/finalize/{draft_id}` переводит черновик в оформленную накладную со статусом «Принято в ПВЗ» и печатью ярлыка/квитанции.
   - Body: `{"print_label": true, "print_receipt": true}`
   - Response: `{"waybill_id": "uuid", "status": "accepted_at_pvz", "label_url": "..."}`
    
8. Дополнительная упаковка/услуги при необходимости оформляются отдельным запросом `POST /api/v1/waybills/{draft_id}/services` до финального подтверждения и печати документов.
   - Body: `{"service_code": "box", "quantity": 1, "price": 50}`
   - Response: `{"service_id": "uuid", "total_cost": 600}`

## 4. Приемка в ПВЗ без предварительного черновика

1. Если у пользователя нет черновика, оператор ПВЗ создает черновик накладной по информации клиента через `POST /api/v1/waybills/drafts/from-counter` с автоматическим заполнением доступных полей.
   - Body: `{"sender_data": {...}, "recipient_data": {...}, "items": [...]}`
   - Response: `{"draft_id": "uuid", "barcode": "654321", "status": "draft"}`
    
2. Оператор указывает плательщика и метод оплаты для созданного черновика отдельным запросом `PUT /api/v1/waybills/drafts/{draft_id}/payment`, при плательщике «отправитель» оплата выполняется на ПВЗ по шагам раздела 3.
   - Body: `{"payer": "sender", "payment_method": "card"}`
   - Response: `{"draft_id": "uuid", "updated": true}`
    
3. Оператор выполняет проверку веса/габаритов отдельными запросами `POST /api/v1/acceptance/verify/{draft_id}`, после чего система пересчитывает стоимость и сроки доставки.
   - Body: `{"weight": 2.0, "dimensions": {"length": 30, "width": 20, "height": 10}}`
   - Response: `{"verified": true, "recalculated_cost": 600}`
    
4. Пользователь подтверждает условия отправления отдельным запросом `POST /api/v1/waybills/{draft_id}/confirm`, после чего черновик конвертируется в оформленную накладную запросом `POST /api/v1/waybills/finalize/{draft_id}`.
   - Response: `{"waybill_id": "uuid", "status": "accepted_at_pvz"}`
    
5. При необходимости добавляются платные услуги/упаковка отдельным запросом `POST /api/v1/waybills/{draft_id}/services` до печати ярлыка и смены статуса на «Принято в ПВЗ».
   - Body: `{"service_code": "packaging", "quantity": 1}`
   - Response: `{"service_id": "uuid", "total_cost": 650}`

## 5. Отслеживание статуса и уведомления

1. Пользователь получает текущий статус черновика/заказа через `GET /api/v1/tracking/{waybill_id}`, включая этапы «Черновик создан», «Принято в ПВЗ», «На складе», «В пути», «Доставлено».
   - Response: `{"waybill_id": "uuid", "status": "in_transit", "eta": "2025-11-01T15:00Z"}`
    
2. Подписка и отписка на уведомления на email/SMS/push выполняются отдельными запросами `POST /api/v1/notifications/subscribe` с выбором каналов, включая уведомления «ожидает оплаты получателем» и «оплата получена».
   - Body: `{"waybill_id": "uuid", "channels": ["email", "sms", "push"]}`
   - Response: `{"subscription_id": "uuid", "status": "active"}`
    
3. История статусов, уведомлений и ETA доступна через `GET /api/v1/tracking/{waybill_id}/history` с возможностью ручного обновления прогноза отдельным запросом `PUT /api/v1/tracking/{waybill_id}/eta`.
   - Response: `{"events": [...], "eta_updated": "2025-11-01T15:00Z"}`

## 6. Отслеживание посылки неавторизованным получателем

1. Неавторизованный получатель открывает публичную страницу трекинга или переходит по ссылке из SMS-уведомления и вводит номер накладной и свой номер телефона получателя, указанный в накладной.
    
2. Система отправляет запрос `POST /api/v1/tracking/public/verify` для проверки совпадения номера накладной и телефона получателя без требования авторизации или регистрации.
   - Body: `{"waybill_number": "WB-123456", "phone_number": "+7..."}`
   - Response: `{"verified": true, "waybill_id": "uuid"}`
    
3. При успешной проверке система возвращает текущий статус посылки через `GET /api/v1/tracking/public/{waybill_id}`, включая этапы «Оформлено», «На складе», «В пути», «Прибыло в ПВЗ/На доставке», «Доставлено», с актуальным ETA и историей перемещений.
   - Response: `{"status": "in_delivery", "eta": "2025-11-01T16:00Z", "events": [...]}`
    
4. Если в накладной указан признак «ожидает оплаты получателем», система отображает сумму к оплате и способы оплаты через `GET /api/v1/tracking/public/{waybill_id}/payment-info` без возможности онлайн-оплаты до выдачи.
   - Response: `{"amount": 550, "payment_required": true, "methods": ["cash", "card"]}`

## 7. Отмена до сдачи и возвраты

1. Пользователь может отменить черновик накладной до фактической сдачи в ПВЗ отдельным запросом `DELETE /api/v1/waybills/drafts/{draft_id}`, при наличии предоплаты оформляется возврат по типу платежа отдельным запросом `POST /api/v1/payments/refund`.
   - Body: `{"payment_id": "uuid", "reason": "user_request"}`
   - Response: `{"refund_id": "uuid", "status": "processed"}`
    
2. После сдачи инициируются процедуры отмен/возвратов в зависимости от этапа логистики: запрос `POST /api/v1/waybills/{waybill_id}/stop-processing` для остановки обработки и запрос `POST /api/v1/waybills/{waybill_id}/process-return` для оформления возврата/переадресации, при наличных создается кассовая корректировка с фиксацией «возвращено/сдано» отдельным запросом.
   - Body: `{"reason": "customer_request"}`
   - Response: `{"waybill_id": "uuid", "status": "stopped"}`

## 8. Складская приемка и отгрузка

1. Поступление на склад регистрируется запросом `POST /api/v1/warehouse/intake` с привязкой мест к заказам и сканированием штрихкодов.
   - Body: `{"waybill_ids": ["id1", "id2"], "scanned_barcodes": ["code1", "code2"]}`
   - Response: `{"intake_id": "uuid", "items_received": 2}`
    
2. Создание отгрузки выполняется отдельным запросом `POST /api/v1/warehouse/shipments`, назначение ТС/водителя и слота погрузки — запросом `PUT /api/v1/warehouse/shipments/{shipment_id}/assign`.
   - Body: `{"vehicle_id": "v123", "driver_id": "d456", "loading_slot": 1}`
   - Response: `{"shipment_id": "uuid", "assigned": true}`
    
3. Погрузка мест подтверждается сканами отдельными вызовами `POST /api/v1/warehouse/shipments/{shipment_id}/load-item`, после чего выезд со склада фиксируется запросом `POST /api/v1/warehouse/shipments/{shipment_id}/depart`.
   - Body: `{"departure_time": "2025-11-01T10:30:00Z", "vehicle_gps": {...}}`
   - Response: `{"shipment_id": "uuid", "status": "departed"}`
    
4. Статусы загрузки/отправки и телеметрия рейсов мониторятся в реальном времени через `GET /api/v1/warehouse/shipments/{shipment_id}/telemetry`.
   - Response: `{"current_location": {...}, "eta": "2025-11-01T15:00Z", "status": "in_transit"}`

## 9. Получение посылки неавторизованным контактом на ПВЗ

1. Неавторизованный получатель приходит в ПВЗ назначения с документом, удостоверяющим личность, и сообщает номер накладной или телефон оператору.
    
2. Оператор ПВЗ находит накладную по номеру или телефону получателя через `GET /api/v1/waybills/search`, система отображает ФИО и телефон получателя из записи типа UNREGISTERED_CONTACT.
   - Response: `{"waybill_id": "uuid", "recipient_name": "...", "phone": "+7..."}`
    
3. Оператор сверяет данные документа получателя (паспорт) с данными в накладной отдельным запросом `POST /api/v1/waybills/{waybill_id}/verify-recipient`, при совпадении ФИО и отсутствии расхождений идентификация считается успешной.
   - Body: `{"document_type": "passport", "document_data": {...}}`
   - Response: `{"verified": true, "recipient_id": "uuid"}`
    
4. Если плательщик — получатель и посылка не оплачена, оператор проверяет статус оплаты запросом `GET /api/v1/payments/status/{waybill_id}` и инициирует процесс оплаты:
    
    - **Карта** — оператор запускает оплату через эквайринг запросом `POST /api/v1/payments/initiate-card`, при успехе система отмечает «оплачено» отдельным запросом `POST /api/v1/payments/confirm/{payment_id}` и печатает чек.
        - Response: `{"payment_id": "uuid", "status": "completed"}`
        
    - **Наличные** — оператор открывает прием наличных запросом `POST /api/v1/payments/initiate-cash`, вводит полученную сумму, система рассчитывает сдачу; оператор фиксирует «получено/сдано» отдельным запросом `POST /api/v1/payments/finalize-cash/{payment_id}` и печатает чек.
        - Response: `{"status": "completed", "change": 0}`
        
5. После подтверждения оплаты или при предоплате отправителем оператор завершает выдачу запросом `POST /api/v1/waybills/{waybill_id}/complete-delivery`, система переводит накладную в статус «Доставлено» и отправляет SMS-уведомление получателю.
   - Body: `{"recipient_id": "uuid", "confirmation_method": "signature"}`
   - Response: `{"waybill_id": "uuid", "status": "delivered"}`
    
6. Оператор выдает посылку получателю, система фиксирует факт выдачи с временной меткой отдельным запросом `POST /api/v1/audit/log-delivery` для аудита и статистики.
   - Body: `{"waybill_id": "uuid", "timestamp": "...", "recipient_id": "uuid"}`
   - Response: `{"log_id": "uuid", "recorded": true}`

## 10. Доставка и завершение (курьер)

1. Курьер запрашивает список назначений и маршрут через `GET /api/v1/delivery/courier/assignments`. Также ему указывают какие клиенты должны оплатить заказ и каким способом. Если способ наличка - указывает какую сдачу курьер должен иметь на руках.
   - Response: `{"assignments": [...], "route": {...}, "change_required": {"total": 5000}}`
	
2. Старт рейса фиксируется отдельным запросом `POST /api/v1/delivery/courier/start-route` с временем и геопозицией начала.
   - Body: `{"courier_id": "c123", "start_time": "...", "start_gps": {...}}`
   - Response: `{"route_id": "uuid", "status": "started"}`
    
3. Перед выдачей заказа курьер проверяет статусы оплаты запросом `GET /api/v1/payments/batch-status`, если плательщик — получатель и заказ не оплачен, выполняет оплату у двери.
   - Response: `{"items": [{"waybill_id": "uuid", "status": "pending"}]}`
    
4. Оплата у курьера:
    
    - **Карта** — инициировать оплату на мобильном терминале запросом `POST /api/v1/payments/mobile-terminal/initiate-card`, по успеху отметить «оплачено» отдельным запросом `POST /api/v1/payments/confirm/{payment_id}`.
        - Response: `{"payment_id": "uuid", "status": "completed"}`
        
    - **Наличные** — открыть прием наличных запросом `POST /api/v1/payments/initiate-cash`, ввести «получено», система рассчитывает сдачу, зафиксировать «получено/сдано» отдельным запросом `POST /api/v1/payments/finalize-cash/{payment_id}`.
        - Response: `{"status": "completed", "change": 0}`
        
5. Координаты передаются в трекинг каждые N секунд через `POST /api/v1/geolocation/update-position` до завершения рейса.
   - Body: `{"courier_id": "c123", "latitude": 55.75, "longitude": 37.62, "timestamp": "..."}`
   - Response: `{"position_id": "uuid", "recorded": true}`
    
6. Промежуточные статусы «в пути», «задержка», «не удалось доставить» отмечаются отдельными запросами `PUT /api/v1/delivery/courier/{waybill_id}/status`.
   - Body: `{"status": "in_transit", "note": "On the way"}`
   - Response: `{"waybill_id": "uuid", "status": "updated"}`
    
7. Успешная доставка подтверждается запросом `POST /api/v1/delivery/courier/{waybill_id}/complete`, заказ закрывается, клиент получает уведомление.
   - Body: `{"recipient_signature": "...", "photo_proof": "..."}`
   - Response: `{"waybill_id": "uuid", "status": "delivered"}`
    
8. Если оплатить не удалось — завершить как «FailedAttempt» отдельным запросом `POST /api/v1/delivery/courier/{waybill_id}/failed-attempt` с указанием причины.
   - Body: `{"reason": "recipient_absent", "retry_date": "2025-11-02"}`
   - Response: `{"waybill_id": "uuid", "status": "failed_attempt"}`

## 11. Получение посылки неавторизованным контактом от курьера

1. Курьер прибывает по адресу доставки и связывается с получателем по телефону из накладной, сверяет личность получателя с данными в системе через `POST /api/v1/delivery/courier/verify-recipient`.
   - Body: `{"phone_number": "+7...", "waybill_id": "uuid"}`
   - Response: `{"verified": true, "recipient_id": "uuid"}`
    
2. Курьер проверяет статус оплаты накладной запросом `GET /api/v1/payments/status/{waybill_id}`; если плательщик — получатель и заказ не оплачен, инициирует процесс оплаты на месте:
    
    - **Карта** — курьер запускает оплату на мобильном терминале запросом `POST /api/v1/payments/mobile-terminal/initiate-card`, при успехе отмечает «оплачено» отдельным запросом `POST /api/v1/payments/confirm/{payment_id}`.
        - Response: `{"payment_id": "uuid", "status": "completed"}`
        
    - **Наличные** — курьер открывает прием наличных запросом `POST /api/v1/payments/initiate-cash`, вводит полученную сумму, система рассчитывает сдачу; курьер фиксирует «получено/сдано» отдельным запросом `POST /api/v1/payments/finalize-cash/{payment_id}`.
        - Response: `{"status": "completed", "change": 0}`
        
3. После подтверждения оплаты или при предоплате отправителем курьер завершает доставку запросом `POST /api/v1/delivery/courier/{waybill_id}/complete`, система переводит накладную в статус «Доставлено» с геопозицией и временем.
   - Body: `{"recipient_id": "uuid", "gps_coords": {...}, "timestamp": "..."}`
   - Response: `{"waybill_id": "uuid", "status": "delivered"}`
    
4. Система автоматически отправляет SMS-уведомление получателю с подтверждением доставки и предложением зарегистрироваться для доступа к истории отправлений через `POST /api/v1/notifications/send-registration-offer`.
   - Body: `{"phone_number": "+7...", "waybill_id": "uuid"}`
   - Response: `{"notification_id": "uuid", "status": "sent"}`
    
5. Если получатель отсутствует или отказывается от получения, курьер отмечает статус «не удалось доставить» отдельным запросом `POST /api/v1/delivery/courier/{waybill_id}/failed-attempt` с указанием причины для повторной попытки или возврата отправителю.
   - Body: `{"reason": "recipient_absent"}`
   - Response: `{"waybill_id": "uuid", "status": "failed_attempt"}`

## 12. Доставка и завершение (водитель)

1. Водитель получает план рейса Склад–ПВЗ/ПВЗ–Склад/Склад–Склад через `GET /api/v1/delivery/driver/routes`.
   - Response: `{"routes": [{...}], "status": "assigned"}`
    
2. Прибытие на склад и готовность к погрузке фиксируются запросом `POST /api/v1/warehouse/shipments/{shipment_id}/arrival`.
   - Body: `{"driver_id": "d456", "arrival_time": "...", "vehicle_id": "v123"}`
   - Response: `{"shipment_id": "uuid", "status": "ready_for_loading"}`
    
3. Погрузка каждого места подтверждается сканированием отдельными вызовами `POST /api/v1/warehouse/shipments/{shipment_id}/load-item`, после чего формируется акт погрузки запросом `POST /api/v1/warehouse/shipments/{shipment_id}/loading-document`.
   - Body: `{"total_items": 5, "total_weight": 10.5}`
   - Response: `{"document_id": "uuid", "status": "generated"}`
    
4. Выезд со склада и прибытие на точку назначения фиксируются разными запросами `POST /api/v1/warehouse/shipments/{shipment_id}/milestone` с временными метками.
   - Body: `{"milestone": "departed", "timestamp": "...", "gps": {...}}`
   - Response: `{"milestone_id": "uuid", "recorded": true}`
    
5. Разгрузка и закрытие рейса выполняются финальным запросом `POST /api/v1/warehouse/shipments/{shipment_id}/close` с метриками рейса (время, километраж, отклонения).
   - Body: `{"metrics": {"duration": 180, "distance": 45, "deviations": []}}`
   - Response: `{"shipment_id": "uuid", "status": "closed"}`

## 13. Оценка и отзыв

1. После доставки пользователю предлагается оставить оценку и отзыв в интерфейсе заказов через `GET /api/v1/ratings/request/{waybill_id}`.
   - Response: `{"waybill_id": "uuid", "can_rate": true}`
    
2. Запрос `POST /api/v1/ratings/submit` сохраняет рейтинг и комментарий для анализа качества сервиса и отображения в истории.
   - Body: `{"waybill_id": "uuid", "rating": 5, "comment": "Excellent service!"}`
   - Response: `{"rating_id": "uuid", "recorded": true}`

## 14. Регистрация неавторизованного контакта в системе

1. Неавторизованный получатель переходит на страницу регистрации по ссылке из SMS-уведомления или из публичного трекинга и заполняет форму регистрации, указывая тот же номер телефона, который был в накладной.
    
2. Система отправляет запрос `POST /api/v1/auth/check-contact` для проверки существования пользователя с типом UNREGISTERED_CONTACT по указанному телефону и инициирует процесс верификации.
   - Body: `{"phone_number": "+7..."}`
   - Response: `{"exists": true, "user_type": "UNREGISTERED_CONTACT"}`
    
3. После подтверждения телефона запросом `POST /api/v1/auth/verify-phone` система обновляет запись пользователя запросом `PUT /api/v1/users/{user_id}/upgrade-to-client`: меняет role_name с 'UNREGISTERED_CONTACT' на 'CLIENT', добавляет password_hash и email, сохраняя всю историю посылок.
   - Body: `{"password": "***", "email": "user@example.com", "role": "CLIENT"}`
   - Response: `{"user_id": "uuid", "role": "CLIENT", "updated": true}`
    
4. Система предоставляет новому клиенту доступ к личному кабинету с историей всех посылок, где он был указан как получатель или отправитель, включая возможность создания черновиков и управления уведомлениями.
    
5. Первый вход выполняется с новыми учетными данными через `POST /api/v1/auth/login`, система возвращает токен авторизации и открывает полный функционал клиента согласно роли CLIENT.
   - Response: `{"access_token": "jwt_token", "user_role": "CLIENT"}`

## 15. HR, бухгалтерия и интеграция

1. **HR**: создание карточки сотрудника выполняется запросом `POST /api/v1/hr/employees`, изменение должности/статуса — отдельным запросом `PUT /api/v1/hr/employees/{employee_id}`, увольнение — запросом `DELETE /api/v1/hr/employees/{employee_id}` с указанием причины и даты.
   - Response: `{"employee_id": "uuid", "status": "active"}`
    
2. **Бухгалтерия**: изменение окладов/начислений выполняется запросом `PUT /api/v1/accounting/salaries/{employee_id}`, формирование ведомостей — запросом `GET /api/v1/accounting/payroll`, выгрузка отчетов — отдельным запросом `GET /api/v1/accounting/reports/export`.
   - Response: `{"payroll": [...], "total": 500000, "status": "generated"}`
    
3. Сверка платежей и кассовых смен ПВЗ/курьеров формируется отдельным запросом `POST /api/v1/accounting/reconciliation`, расхождения отправляются на модерацию администратору ПВЗ запросом `POST /api/v1/accounting/reconciliation/dispute`.
   - Response: `{"reconciliation_id": "uuid", "discrepancies": []}`
    
4. Доступ к административным журналам (аудит действий HR/бухгалтерии) осуществляется отдельным запросом `GET /api/v1/audit/logs` с фильтрами по периоду/пользователю.
   - Response: `{"logs": [...], "total_records": 500}`

## 16. Курьерские и водительские выплаты

1. Инициация расчета выплат за период для исполнителя выполняется запросом `POST /api/v1/payouts/calculate` с параметрами периода и типа исполнителя.
   - Body: `{"courier_id": "c123", "period_start": "2025-11-01", "period_end": "2025-11-30"}`
   - Response: `{"calculation_id": "uuid", "total_amount": 50000}`
    
2. Подтверждение и отправка на выплату выполняются отдельным запросом `POST /api/v1/payouts/confirm`, статусы начислений запрашиваются через `GET /api/v1/payouts/status`.
   - Response: `{"payouts": [...], "total": 50000}`
    
3. Коррекции и удержания по инцидентам оформляются отдельным запросом `POST /api/v1/payouts/adjustment` с основанием корректировки.
   - Body: `{"courier_id": "c123", "type": "deduction", "amount": 1000, "reason": "damage_claim"}`
   - Response: `{"adjustment_id": "uuid", "recorded": true}`

## 17. Интеграция через пограничные сервисы

1. **Заказы — публичный API**: вызов клиента приходит на edge по `POST /api/v1/orders/create`, edge проверяет токен и маршрутизирует к внутреннему сервису заказов по `POST /internal/waybills/create`, при необходимости агрегируя историю/ETA вызовом к трекингу по `GET /internal/tracking/aggregate/{waybill_id}`.
   - Response: `{"order_id": "uuid", "status": "created"}`
    
2. **Заказы — уведомления**: при создании/изменении edge инициирует рассылку, вызывая шаблоны и очередь уведомлений по `POST /internal/notifications/queue` с троттлингом/ретраями на границе.
   - Response: `{"notification_id": "uuid", "queued": true}`
    
3. **Заказы — версии и лимиты**: edge применяет canary/blue-green и rate limiting на публичном пути по `GET /api/v1/status/health`, а служебные метрики/health доступны на админ-пути.
   - Response: `{"status": "healthy", "version": "1.2.3"}`
    
4. **Офисы (HR)**: админ-панель вызывает защищенный путь edge по `GET /api/v1/admin/employees`, edge проверяет роли и маршрутизирует к HR-сервису по `GET /internal/hr/employees`, аудит фиксируется отдельным вызовом по `POST /internal/audit/log`.
   - Response: `{"employees": [...], "total": 50}`
    
5. **Офисы (бухгалтерия)**: панель бухгалтера вызывает расчеты/отчеты на edge по `GET /api/v1/admin/accounting/reports`, edge маршрутизирует к сервису бухгалтерии по `GET /internal/accounting/reports` и к сервису выплат по `GET /internal/payouts/status`, формируя согласованный ответ.
   - Response: `{"reports": [...], "total_revenue": 1000000}`
    
6. **Доставка (курьеры)**: мобильный клиент курьера получает задания по `GET /api/v1/delivery/courier/assignments`, отправляет GPS по выделенному пути `POST /api/v1/geolocation/track`, завершение доставки подтверждает отдельным вызовом по `POST /api/v1/delivery/courier/complete`, включая оплату получателем при необходимости.
   - Response: `{"assignments": [...], "route": {...}}`
    
7. **Доставка (водители)**: мобильный клиент водителя получает рейсы по `GET /api/v1/delivery/driver/routes`, фиксирует погрузку/выезд/прибытие разными вызовами по `POST /api/v1/warehouse/milestones`, закрывает рейс финальным вызовом по `POST /api/v1/warehouse/shipments/close`.
   - Response: `{"routes": [...], "status": "assigned"}`
    
8. **Ошибки и деградация**: для всех публичных путей edge возвращает нормализованные ошибки и fallback-ответы по `GET /api/v1/error/handle`, а технические события отказов отправляет в телеметрию по `POST /internal/telemetry/failures`.
   - Response: `{"error": "Service unavailable", "fallback_data": {...}}`

