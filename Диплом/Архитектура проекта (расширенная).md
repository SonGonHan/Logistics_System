#диплом #расширенная-версия

## Обзор архитектуры

Система построена по **enterprise-уровню микросервисной архитектуры** с модульной организацией внутри сервисов:
- **6 независимых приложений** (развертываемых сервисов)
- **15 логических модулей** внутри монолитных сервисов
- **1 база данных PostgreSQL** с 10 изолированными схемами (с возможностью разделения)
- Использование **Spring Modulith** для контроля границ между модулями
- **Асинхронная коммуникация** через RabbitMQ/Kafka
- **Распределенная трассировка** через Jaeger
- **Мониторинг** через Prometheus + Grafana

**Принципы:**
- Каждый модуль работает со своей схемой БД
- Модули взаимодействуют через внутренние API или события (event-driven)
- Микросервисы коммуницируют через REST API + Message Queue
- Готовность к горизонтальному масштабированию
- Production-ready инфраструктура

**Дополнительный функционал по сравнению с базовой версией:**
- ✅ Отдельный Edge Service (Spring Cloud Gateway)
- ✅ Notification Service с поддержкой email/SMS/push
- ✅ GPS-отслеживание курьеров и грузовиков в реальном времени
- ✅ Расчет ETA (ожидаемого времени доставки)
- ✅ Асинхронная обработка через RabbitMQ
- ✅ Distributed tracing (Jaeger)
- ✅ Централизованное логирование (ELK Stack)
- ✅ Мониторинг метрик (Prometheus + Grafana)
- ✅ Redis для кэширования
- ✅ Продвинутая аналитика и отчетность

---

# Сервис 1: Edge Service (API Gateway)

**Тип:** Независимый микросервис  
**Порт:** 8080  
**База данных:** Не требуется (stateless)

**Для чего нужен:** Единая точка входа для всех внешних запросов с маршрутизацией к внутренним сервисам, проверкой токенов и управлением нагрузкой.

**Необходимый функционал:**
- Проверка токенов авторизации (JWT validation через User Service)
- Маршрутизация запросов к внутренним сервисам
- Проверка ролей и прав доступа (RBAC)
- Агрегация данных от нескольких сервисов (BFF pattern)
- Rate limiting и троттлинг по пользователям
- Управление версиями API (canary/blue-green deployments)
- Возврат нормализованных ошибок и fallback-ответов
- Отправка метрик и телеметрии отказов

**Где используется:** Все клиентские приложения (Web, Mobile)

**Дополнительный функционал:**
- Кэширование часто запрашиваемых данных (Redis)
- Трансформация форматов запросов/ответов
- A/B тестирование функциональности
- Защита от DDoS-атак (rate limiting)
- Централизованное логирование и трассировка запросов (Jaeger)
- CORS configuration для мультиплатформенных клиентов

**Технологии:** Spring Cloud Gateway, Redis, Resilience4j (Circuit Breaker)

**Маршруты:**
```yaml
/api/auth/**          → User Management Service
/api/users/**         → User Management Service
/api/waybills/**      → Core Business Service
/api/pricing/**       → Core Business Service
/api/warehouse/**     → Logistics Service
/api/delivery/**      → Logistics Service
/api/tracking/**      → Logistics Service
/api/payments/**      → Payment Service
/api/hr/**            → HR & Accounting Service
/api/notifications/** → Notification Service
```

---

# Сервис 2: User Management Service

**Тип:** Независимый микросервис  
**Порт:** 8081  
**База данных:** Схема `user_management` (users, sessions, audit_logs)

**Для чего нужен:** Обеспечивает регистрацию, авторизацию и управление учетными записями пользователей всех типов в системе, включая аудит действий.

**Модули внутри:**
- **User Module** - управление пользователями
- **Auth Module** - аутентификация и авторизация  
- **Audit Module** - логирование критических действий

## 2.1 User Module

**Схема БД:** `user_management.users`

**Необходимый функционал:**
- Регистрация новых пользователей с созданием учетной записи
- Автоматическое создание UNREGISTERED_CONTACT при сдаче посылки
- Преобразование UNREGISTERED_CONTACT → CLIENT при регистрации
- Хранение и управление профилями пользователей
- Изменение ролей и статусов пользователей
- Экспорт списков пользователей (для администраторов)

**Роли:**
- UNREGISTERED_CONTACT
- CLIENT
- PVZ_OPERATOR, PVZ_ADMIN
- COURIER, DRIVER, DISPATCHER
- WAREHOUSE_OPERATOR, WAREHOUSE_ADMIN
- HR, ACCOUNTANT, SYSTEM_ADMIN

## 2.2 Auth Module

**Схема БД:** `user_management.user_sessions`

**Необходимый функционал:**
- Авторизация пользователей с выдачей JWT токенов
- Проверка и валидация токенов авторизации
- Refresh token механизм
- Управление сессиями пользователей
- Двухфакторная аутентификация (2FA)
- Восстановление пароля через email/SMS
- OAuth2 интеграция (Google, Yandex ID)

## 2.3 Audit Module

**Схема БД:** `user_management.audit_logs`

**Необходимый функционал:**
- Логирование действий HR и бухгалтерии
- Хранение журналов с фильтрацией по периоду и пользователю
- Предоставление доступа к административным журналам
- Фиксация технических событий и отказов
- Экспорт журналов аудита для compliance

**Взаимодействие между модулями:**
- User → Audit (события через Spring Application Events)
- Auth → User (прямые вызовы через internal API)
- Audit → Notification Service (уведомления о критических событиях через RabbitMQ)

**Технологии:** Spring Boot, Spring Security, JWT, Spring Modulith, RabbitMQ

---

# Сервис 3: Notification Service

**Тип:** Независимый микросервис  
**Порт:** 8082  
**База данных:** Схема `notification_service` (notification_queue, templates, channels, user_preferences)

**Для чего нужен:** Централизованная отправка уведомлений пользователям по различным каналам (email, SMS, push).

**Необходимый функционал:**
- Управление шаблонами уведомлений с подстановкой переменных
- Отправка уведомлений через email (SMTP)
- Отправка SMS через Twilio/SMSC
- Отправка push-уведомлений (Firebase Cloud Messaging)
- Управление очередью уведомлений с ретраями и приоритизацией
- Обработка подписок на уведомления (пользователь выбирает каналы)
- Персонализация контента уведомлений
- Отслеживание доставляемости уведомлений

**Где используется:** Все сервисы (асинхронно через RabbitMQ)

**Дополнительный функционал:**
- Аналитика доставляемости уведомлений
- Интеграция с мессенджерами (Telegram Bot API, WhatsApp Business)
- Планирование отложенных уведомлений
- Batch отправка уведомлений (например, рассылка по всем клиентам)
- Локализация уведомлений (русский, английский)

**Очередь уведомлений (RabbitMQ):**
```json
{
  "userId": 12345,
  "templateId": "ORDER_DELIVERED",
  "channel": "EMAIL",
  "priority": "HIGH",
  "variables": {
    "orderNumber": "TR-123456",
    "deliveryTime": "2025-10-28 14:30"
  }
}
```

**Технологии:** Spring Boot, RabbitMQ, Twilio API, Firebase Admin SDK, Thymeleaf (шаблоны email)

---

# Сервис 4: Core Business Service

**Тип:** Модульный монолит  
**Порт:** 8083  
**База данных:** Схемы `waybill_service`, `rating_service`, `shared_data` (read-only)

**Для чего нужен:** Основная бизнес-логика системы - управление накладными, тарификацией, приемкой и отзывами.

**Модули внутри:**

## 4.1 Waybill Module

**Схема БД:** `waybill_service`

**Необходимый функционал:**
- Создание и сохранение черновиков накладных с присвоением ID/штрихкода
- Редактирование черновиков до момента сдачи
- Конвертация черновика в оформленную накладную
- Хранение информации о плательщике и методе оплаты
- Отмена черновиков и накладных
- Шаблоны часто используемых накладных
- Массовое создание накладных (импорт из Excel/CSV)
- Экспорт накладных в различные форматы

**Где используется:** Клиенты, ПВЗ

**События:**
- `WaybillCreatedEvent` → Notification Service (уведомление клиенту)
- `WaybillStatusChangedEvent` → Tracking Module

## 4.2 Pricing Module

**Схема БД:** `shared_data.pricing_rules`, `shared_data.service_catalog`

**Необходимый функционал:**
- Предварительная калькуляция стоимости и сроков доставки
- Пересчет стоимости после проверки фактических параметров груза
- Учет дополнительных услуг в расчете стоимости
- Расчет сдачи при оплате наличными
- Динамическое ценообразование на основе загрузки
- Скидки и промокоды
- Специальные тарифы для корпоративных клиентов
- История изменения тарифов

**Где используется:** Waybill Module, Acceptance Module

## 4.3 Acceptance Module

**Схема БД:** `waybill_service.acceptance_records`

**Необходимый функционал:**
- Поиск черновиков по штрихкоду/ID
- Регистрация фактического веса и габаритов груза
- Фотофиксация посылок (загрузка в облако)
- Добавление дополнительных услуг и упаковки
- Печать ярлыков и квитанций
- Автоматическое определение габаритов по фото (ML)
- Контроль запрещенных к перевозке вложений
- Страхование грузов

**Где используется:** ПВЗ

**События:**
- `PackageAcceptedEvent` → Notification Service (уведомление отправителю)
- `PackageAcceptedEvent` → Warehouse Module (регистрация в складской системе)

## 4.4 Rating Module

**Схема БД:** `rating_service`

**Необходимый функционал:**
- Сохранение оценок и отзывов клиентов
- Хранение истории отзывов
- Предоставление интерфейса для оставления отзывов после доставки
- Аналитика качества обслуживания
- Автоматическая модерация отзывов (фильтрация мата)
- Система реагирования на негативные отзывы
- Публичный рейтинг курьеров и ПВЗ

**Где используется:** Клиенты, Администраторы

**Взаимодействие между модулями Core Business Service:**
- Waybill → Pricing (расчет стоимости)
- Acceptance → Pricing (пересчет после проверки)
- Acceptance → Waybill (обновление статуса)
- Rating → Waybill (связь отзыва с накладной)
- Все модули → RabbitMQ (публикация событий)

**Технологии:** Spring Boot, Spring Modulith, Spring Data JPA, RabbitMQ

---

# Сервис 5: Logistics Service

**Тип:** Модульный монолит  
**Порт:** 8084  
**База данных:** Схемы `warehouse_service`, `delivery_service`, `shared_data` (read-only)

**Для чего нужен:** Управление складской логистикой, доставкой, геолокацией и отслеживанием посылок.

**Модули внутри:**

## 5.1 Warehouse Module

**Схема БД:** `warehouse_service`

**Необходимый функционал:**
- Регистрация поступления посылок на склад со сканированием штрихкодов
- Создание отгрузок и формирование списков мест
- Назначение транспортных средств и водителей для отгрузки
- Назначение слотов погрузки
- Подтверждение погрузки мест
- Фиксация выезда со склада
- Мониторинг статусов загрузки и отправки
- Оптимизация размещения грузов на складе
- Инвентаризация
- Контроль сроков хранения
- Автоматическая маршрутизация перемещений

**Где используется:** Склад

**События:**
- `ShipmentCreatedEvent` → Tracking Module (обновление статуса накладных)
- `ShipmentDepartedEvent` → Geolocation Module (начало GPS-трекинга)

## 5.2 Delivery Module

**Схема БД:** `delivery_service.deliveries`, `delivery_service.courier_routes`

**Необходимый функционал:**
- Формирование списков назначений и маршрутов для курьеров
- Расчет необходимой сдачи для курьеров
- Получение планов рейсов для водителей (Склад-ПВЗ/ПВЗ-Склад/Склад-Склад)
- Фиксация старта и завершения рейсов
- Обновление промежуточных статусов доставки
- Подтверждение успешной доставки
- Регистрация неудачных попыток доставки с указанием причин
- Формирование актов погрузки/разгрузки
- Оптимизация маршрутов с учетом пробок (интеграция с Yandex Maps API)
- Динамическое перераспределение заказов между курьерами
- Интеграция с навигационными системами
- Анализ эффективности курьеров

**Где используется:** Доставка

**События:**
- `DeliveryStartedEvent` → Geolocation Module (начало GPS-треккинга)
- `DeliveryCompletedEvent` → Notification Service (уведомление получателю)
- `DeliveryCompletedEvent` → Rating Module (запрос отзыва)

## 5.3 Geolocation Module

**Схема БД:** `delivery_service.geolocation_history`

**Для чего нужен:** Собирает и обрабатывает данные о местоположении курьеров и транспортных средств в реальном времени.

**Необходимый функционал:**
- Прием координат от курьеров с заданной периодичностью (каждые 30 секунд)
- Хранение истории перемещений (GPS-треки)
- Фиксация геопозиций при старте рейсов
- Передача данных телеметрии рейсов
- Определение текущего местоположения курьера
- Геозоны и автоматические уведомления при входе/выходе
- Анализ отклонений от маршрута
- Расчет фактического пробега
- Тепловые карты загруженности районов

**Где используется:** Delivery Module, Tracking Module, Клиенты

**WebSocket API для реал-тайм треккинга:**
```javascript
// Клиент подписывается на обновления курьера
ws://logistics-service:8084/ws/courier/{courierId}/location
```

## 5.4 Tracking Module

**Схема БД:** `delivery_service.tracking_events`, `waybill_service.waybill_status_history` (read-only)

**Для чего нужен:** Отслеживает и хранит историю статусов заказов, рассчитывает ETA и управляет подписками на уведомления.

**Необходимый функционал:**
- Получение текущего статуса заказа/черновика
- Хранение истории изменения статусов
- Подписка и отписка на уведомления (email/SMS/push)
- Расчет и обновление ETA (ожидаемого времени доставки) на основе GPS
- Публичный трекинг для неавторизованных пользователей
- Интерактивная карта с отслеживанием в реальном времени
- Предиктивная аналитика задержек (ML)
- Настройка персональных правил уведомлений
- Push-уведомления о приближении курьера (геозона 1 км)

**Где используется:** Клиенты, ПВЗ, Склад, Доставка, Администраторы

**Расчет ETA:**
```python
ETA = текущее_время + (оставшееся_расстояние / средняя_скорость_курьера) + задержка_на_пробки
```

**Кэширование ETA:** Redis (обновляется каждые 2 минуты)

**Взаимодействие между модулями Logistics Service:**
- Warehouse → Delivery (создание рейсов)
- Delivery → Geolocation (запись координат)
- Tracking → Geolocation (чтение позиций для ETA)
- Tracking → Delivery (получение статусов доставки)
- Geolocation → Notification Service (push при входе в геозону)

**Технологии:** Spring Boot, Spring Modulith, PostgreSQL, Redis (кэш ETA), WebSocket (реал-тайм треккинг), RabbitMQ

---

# Сервис 6: Payment & HR Service

**Тип:** Модульный монолит  
**Порт:** 8085  
**База данных:** Схемы `payment_service`, `hr_service`, `shared_data` (read-only)

**Для чего нужен:** Обработка платежей, кадровый учет и бухгалтерия.

**Модули внутри:**

## 6.1 Payment Module

**Схема БД:** `payment_service`

**Необходимый функционал:**
- Инициация платежей через эквайринг (оплата картой)
- Обработка наличных платежей с расчетом сдачи
- Оплата через СБП (Система Быстрых Платежей)
- Проверка статуса оплаты заказов
- Фиксация факта оплаты с указанием метода
- Оформление возвратов платежей
- Печать чеков и квитанций
- Интеграция с различными платежными системами (Stripe, Яндекс.Касса)
- Рассрочка и кредитные платежи
- Электронные чеки (отправка по email)
- Автоматическая сверка платежей
- PCI DSS compliance

**Где используется:** ПВЗ, Доставка, Бухгалтеры

**События:**
- `PaymentCompletedEvent` → Notification Service (уведомление об оплате)
- `PaymentCompletedEvent` → Core Business Service (обновление статуса накладной)

**Технологии:** Spring Boot, Stripe API, PCI DSS сертификация

## 6.2 HR Module

**Схема БД:** `hr_service.employees`, `hr_service.positions`

**Необходимый функционал:**
- Создание карточек сотрудников
- Изменение должностей и статусов сотрудников
- Оформление увольнений с указанием причины и даты
- Хранение кадровой информации
- Предоставление доступа к административным журналам с аудитом действий
- Управление отпусками и больничными
- Система оценки эффективности сотрудников (KPI)
- Обучение и сертификация персонала
- Рекрутинг и онбординг новых сотрудников

**Где используется:** HR специалисты

## 6.3 Accounting Module

**Схема БД:** `hr_service.employee_payments`, `payment_service` (read-only для сверки)

**Необходимый функционал:**
- Изменение окладов и начислений сотрудников
- Формирование расчетных ведомостей
- Выгрузка финансовых отчетов
- Сверка платежей и кассовых смен ПВЗ/курьеров
- Обработка расхождений с отправкой на модерацию администратору
- Создание кассовых корректировок при возвратах
- Автоматическое формирование налоговой отчетности
- Интеграция с бухгалтерскими системами (1С)
- Бюджетирование и планирование
- Анализ рентабельности по направлениям

**Где используется:** Бухгалтеры

## 6.4 Payout Module

**Схема БД:** `hr_service.employee_payments`

**Необходимый функционал:**
- Расчет выплат за период для курьеров и водителей
- Подтверждение и инициация выплат
- Проверка статусов начислений
- Оформление корректировок и удержаний по инцидентам
- Расчет метрик рейсов (время, километраж, отклонения)
- Различные схемы мотивации (бонусы, KPI)
- Авансовые выплаты
- Интеграция с банковскими системами для автоматических переводов
- Детализация начислений для исполнителей

**Где используется:** Бухгалтеры, Доставка

**Взаимодействие между модулями Payment & HR Service:**
- Payment → HR (данные для сверки выплат курьерам)
- HR → Accounting (данные сотрудников для зарплаты)
- Accounting → Payout (формирование выплат)
- Payout → HR (получение ставок по должностям)

**Технологии:** Spring Boot, Spring Modulith, Jasper Reports, 1С API

---

# Таблица маппинга: Сервисы → Схемы БД (расширенная версия)

| Сервис | Схемы БД (доступ) | Тип доступа |
|--------|-------------------|-------------|
| Edge Service | - | - |
| User Management Service | user_management | Read/Write |
| Notification Service | notification_service | Read/Write |
| Core Business Service | waybill_service, rating_service | Read/Write |
| Core Business Service | shared_data | Read-only |
| Logistics Service | warehouse_service, delivery_service | Read/Write |
| Logistics Service | shared_data, waybill_service | Read-only |
| Payment & HR Service | payment_service, hr_service | Read/Write |
| Payment & HR Service | shared_data | Read-only |

---

# Схемы базы данных (расширенная версия)

**Используемые схемы:**
1. `user_management` - пользователи, сессии, аудит
2. `waybill_service` - черновики и накладные
3. `payment_service` - платежи, чеки, возвраты
4. `delivery_service` - маршруты, GPS-треки, отслеживание
5. `warehouse_service` - складские запасы, грузоперевозки
6. `hr_service` - сотрудники, должности, выплаты
7. `notification_service` - шаблоны, очередь уведомлений
8. `rating_service` - отзывы и рейтинги
9. `shared_data` - справочники (тарифы, здания, транспорт)
10. `archive` - архивные таблицы

**Дополнительные таблицы в расширенной версии:**

### delivery_service.courier_routes
- ✅ Добавлено поле `route_path` (JSONB с GPS-треком)

### delivery_service.completed_routes
- ✅ Таблица используется для хранения завершенных маршрутов с полным GPS-треком

### delivery_service.geolocation_history
- ✅ Новая таблица для хранения истории GPS-координат

### warehouse_service.cargo_shipments
- ✅ Добавлено поле `route_path` (GPS-трек грузовика)

### notification_service (новая схема)
- ✅ `notification_channels` - каналы уведомлений
- ✅ `notification_templates` - шаблоны уведомлений
- ✅ `notification_queue` - очередь отправки
- ✅ `user_notification_channels` - настройки пользователей

---

# Технологический стек (расширенная версия)

**Backend:**
- **Framework:** Spring Boot 3.2+, Spring Modulith
- **База данных:** PostgreSQL 15+ (одна БД, 10 схем)
- **Message Queue:** RabbitMQ для асинхронной коммуникации
- **Cache:** Redis для кэширования ETA, сессий, rate limiting
- **API Gateway:** Spring Cloud Gateway (отдельный сервис)
- **Безопасность:** Spring Security, JWT, OAuth2
- **Email:** Spring Mail + Thymeleaf
- **SMS:** Twilio API
- **Push:** Firebase Cloud Messaging

**Infrastructure:**
- **Контейнеризация:** Docker, Docker Compose
- **Оркестрация:** Kubernetes (опционально, для production)
- **Distributed Tracing:** Jaeger
- **Мониторинг:** Prometheus + Grafana
- **Логирование:** ELK Stack (Elasticsearch, Logstash, Kibana)
- **CI/CD:** GitLab CI / GitHub Actions

**Frontend:**
- **Web:** React.js + TypeScript
- **Mobile:** React Native / Flutter
- **Admin Panel:** Angular + Material Design

**External APIs:**
- **Maps:** Yandex Maps API (маршруты, геокодинг)
- **Payment:** Stripe, Яндекс.Касса
- **SMS:** Twilio, SMSC.ru

---

# Межсервисная коммуникация (расширенная версия)

## Синхронная коммуникация (REST API)

**Все запросы через Edge Service:**

```
Client → Edge Service (8080)
    ↓ JWT validation
Edge Service → User Management (8081)
Edge Service → Core Business (8083)
Edge Service → Logistics (8084)
Edge Service → Payment & HR (8085)
```

**Прямые вызовы между сервисами (внутренняя сеть):**

```
Core Business → Payment Service
    GET /internal/payment/status/{waybillId}

Logistics → Core Business
    PUT /internal/waybill/{id}/status
    
Payment & HR → User Management
    GET /internal/user/{id}
```

## Асинхронная коммуникация (RabbitMQ)

**Очереди:**

```
waybill.created       → Notification Service
waybill.status.changed → Notification Service, Tracking Module
payment.completed     → Core Business, Notification Service
delivery.completed    → Notification Service, Rating Module
shipment.departed     → Tracking Module
geolocation.updated   → Tracking Module (ETA calculation)
```

**Пример события:**
```json
{
  "eventType": "WAYBILL_CREATED",
  "timestamp": "2025-10-28T10:30:00Z",
  "payload": {
    "waybillId": 12345,
    "waybillNumber": "TR-123456",
    "senderId": 100,
    "recipientId": 200,
    "createdAt": "2025-10-28T10:30:00Z"
  }
}
```

## Обработка ошибок и отказоустойчивость

**Circuit Breaker (Resilience4j):**
```java
@CircuitBreaker(name = "payment-service", fallbackMethod = "fallbackPaymentStatus")
public PaymentStatus getPaymentStatus(Long waybillId) {
    return paymentServiceClient.getStatus(waybillId);
}

public PaymentStatus fallbackPaymentStatus(Long waybillId, Exception e) {
    return PaymentStatus.UNKNOWN;
}
```

**Retry механизм:**
```java
@Retry(name = "core-business", maxAttempts = 3, waitDuration = 2s)
public Waybill getWaybill(Long id) {
    return coreBusinessClient.getWaybill(id);
}
```

**Distributed Transaction (Saga Pattern):**
```
1. Core Business создает накладную → OK
2. Payment Service обрабатывает платеж → FAIL
3. Core Business откатывает создание накладной (compensating transaction)
```

---

# Развертывание (docker-compose.yml)

```yaml
version: '3.8'

services:
  postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: logistics
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: password
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

  rabbitmq:
    image: rabbitmq:3-management
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: password

  jaeger:
    image: jaegertracing/all-in-one:latest
    ports:
      - "5775:5775/udp"
      - "6831:6831/udp"
      - "6832:6832/udp"
      - "5778:5778"
      - "16686:16686"
      - "14268:14268"

  prometheus:
    image: prom/prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml

  grafana:
    image: grafana/grafana
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_PASSWORD: admin

  edge-service:
    build: ./edge-service
    ports:
      - "8080:8080"
    environment:
      SPRING_REDIS_HOST: redis
      JAEGER_AGENT_HOST: jaeger
    depends_on:
      - redis
      - jaeger

  user-management-service:
    build: ./user-management-service
    ports:
      - "8081:8081"
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/logistics
      SPRING_RABBITMQ_HOST: rabbitmq
      JAEGER_AGENT_HOST: jaeger
    depends_on:
      - postgres
      - rabbitmq
      - jaeger

  notification-service:
    build: ./notification-service
    ports:
      - "8082:8082"
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/logistics
      SPRING_RABBITMQ_HOST: rabbitmq
      TWILIO_ACCOUNT_SID: ${TWILIO_ACCOUNT_SID}
      TWILIO_AUTH_TOKEN: ${TWILIO_AUTH_TOKEN}
      FIREBASE_CONFIG: ${FIREBASE_CONFIG}
    depends_on:
      - postgres
      - rabbitmq

  core-business-service:
    build: ./core-business-service
    ports:
      - "8083:8083"
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/logistics
      SPRING_RABBITMQ_HOST: rabbitmq
      USER_SERVICE_URL: http://user-management-service:8081
      JAEGER_AGENT_HOST: jaeger
    depends_on:
      - postgres
      - rabbitmq
      - user-management-service

  logistics-service:
    build: ./logistics-service
    ports:
      - "8084:8084"
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/logistics
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_REDIS_HOST: redis
      CORE_BUSINESS_URL: http://core-business-service:8083
      JAEGER_AGENT_HOST: jaeger
    depends_on:
      - postgres
      - rabbitmq
      - redis
      - core-business-service

  payment-hr-service:
    build: ./payment-hr-service
    ports:
      - "8085:8085"
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/logistics
      SPRING_RABBITMQ_HOST: rabbitmq
      USER_SERVICE_URL: http://user-management-service:8081
      STRIPE_API_KEY: ${STRIPE_API_KEY}
      JAEGER_AGENT_HOST: jaeger
    depends_on:
      - postgres
      - rabbitmq
      - user-management-service

volumes:
  postgres-data:
```

---

# Мониторинг и наблюдаемость

## Метрики (Prometheus + Grafana)

**Собираемые метрики:**
- Latency (время ответа) для каждого endpoint
- Throughput (количество запросов в секунду)
- Error rate (процент ошибок)
- Circuit breaker состояния
- Размер очередей RabbitMQ
- Количество активных сессий
- CPU и память каждого сервиса

**Dashboards Grafana:**
- Service Overview (общая картина всех сервисов)
- Database Performance (запросы к PostgreSQL)
- Queue Monitoring (RabbitMQ)
- Business Metrics (количество заказов, выручка, доставки)

## Distributed Tracing (Jaeger)

**Трассировка запроса:**
```
Request ID: abc123
├── Edge Service [10ms]
│   └── User Management Service [50ms]
│       └── PostgreSQL Query [30ms]
├── Core Business Service [200ms]
│   ├── Waybill Module [80ms]
│   ├── Pricing Module [60ms]
│   └── RabbitMQ Publish [10ms]
└── Payment Service [150ms]
    ├── Stripe API [100ms]
    └── PostgreSQL Query [40ms]

Total: 410ms
```

## Логирование (ELK Stack)

**Структурированные логи (JSON):**
```json
{
  "timestamp": "2025-10-28T10:30:00Z",
  "service": "core-business-service",
  "level": "INFO",
  "message": "Waybill created successfully",
  "userId": 12345,
  "waybillId": 67890,
  "traceId": "abc123",
  "spanId": "def456"
}
```

**Kibana Dashboards:**
- Error Logs (все ошибки по сервисам)
- Audit Trail (действия пользователей)
- Performance Insights (медленные запросы)

---

# Что реализовано в расширенной версии

## ✅ Полностью реализовано:

**Базовый функционал (как в базовой версии):**
1. Регистрация и авторизация (все роли + OAuth2)
2. Создание и управление накладными
3. Приемка посылок в ПВЗ
4. Складская логистика
5. Доставка курьерами
6. Платежи (включая онлайн-эквайринг)
7. Кадровый учет
8. Бухгалтерия
9. Отзывы

**Дополнительный функционал:**
10. **Отдельный Edge Service** (Spring Cloud Gateway)
11. **Notification Service** (email/SMS/push)
12. **GPS-отслеживание** курьеров и грузовиков в реальном времени
13. **Расчет ETA** (предсказание времени доставки)
14. **WebSocket API** для реал-тайм треккинга
15. **Асинхронная обработка** через RabbitMQ
16. **Distributed Tracing** (Jaeger)
17. **Мониторинг метрик** (Prometheus + Grafana)
18. **Централизованное логирование** (ELK Stack)
19. **Redis кэширование** (ETA, сессии)
20. **Circuit Breaker** и Retry механизмы
21. **Геозоны** и автоматические уведомления
22. **Продвинутая аналитика** (отчеты, dashboards)
23. **Интеграция с внешними API** (Yandex Maps, Stripe, Twilio)
24. **ML для оптимизации** (маршруты, предсказание задержек)

---

# Оценка трудозатрат (расширенная версия)

| Фаза | Недели | Комментарий |
|------|--------|-------------|
| Инфраструктура | 2 | docker-compose, PostgreSQL, RabbitMQ, Redis, Jaeger |
| Edge Service | 1 | Spring Cloud Gateway, rate limiting |
| User Management Service | 2 | Auth, JWT, OAuth2 |
| Notification Service | 2 | Email/SMS/Push, RabbitMQ consumer |
| Core Business Service | 5 | Waybill, Pricing, Acceptance, Rating + события |
| Logistics Service (базовый) | 3 | Warehouse, Delivery, Tracking |
| Geolocation Module | 2 | GPS-треккинг, WebSocket API, ETA |
| Payment & HR Service | 3 | Payment, HR, Accounting, Payout |
| Мониторинг и логирование | 2 | Prometheus, Grafana, ELK |
| Интеграционное тестирование | 3 | Проверка всех сервисов |
| UI (Web + Mobile) | 4 | React, React Native |
| Документация | 1 | API docs, README, deployment |
| **ИТОГО** | **30 недель** | **≈ 7.5 месяцев** |

**С учетом багфиксинга и полировки:** 9-10 месяцев для одного разработчика.

**Рекомендация:** Это версия для развития после диплома или для команды из 2-3 разработчиков.

---

# Миграция с базовой на расширенную версию

## Этап 1: Добавление Edge Service
- Развернуть Spring Cloud Gateway
- Перенести маршрутизацию из User Service

## Этап 2: Добавление Notification Service
- Создать схему `notification_service`
- Настроить RabbitMQ очереди
- Интегрировать Twilio, Firebase

## Этап 3: GPS-отслеживание
- Добавить таблицу `geolocation_history`
- Реализовать WebSocket API
- Внедрить расчет ETA

## Этап 4: Мониторинг
- Настроить Prometheus
- Создать Grafana dashboards
- Развернуть ELK Stack

## Этап 5: Асинхронная обработка
- Перевести критичные операции на RabbitMQ
- Добавить Circuit Breaker
- Внедрить Saga pattern

---

**Расширенная версия — это production-ready система, готовая к масштабированию и эксплуатации в реальных условиях.**