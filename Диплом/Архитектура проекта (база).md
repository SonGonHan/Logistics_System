#диплом #базовая-версия
## Обзор архитектуры

Система построена по **гибридному принципу**, объединяющему преимущества микросервисной и модульной монолитной архитектур:
- **4 независимых приложения** (развертываемых сервиса)
- **11 логических модулей** внутри монолитных сервисов
- **1 база данных PostgreSQL** с 7 изолированными схемами
- Использование **Spring Modulith** для контроля границ между модулями

**Принципы:**
- Каждый модуль работает со своей схемой БД
- Модули взаимодействуют через внутренние API или синхронные REST вызовы
- Упрощенная разработка и развертывание
- Возможность выделения модуля в отдельный микросервис в будущем

**Отличия от расширенной версии:**
- ❌ Нет отдельного Edge Service (API Gateway встроен в User Service)
- ❌ Нет Notification Service (уведомления через Spring Mail в сервисах)
- ❌ Нет GPS-отслеживания в реальном времени
- ❌ Упрощенный Tracking (только статусы, без ETA)
- ❌ Базовый HR и Accounting (без сложной аналитики)
- ✅ Все основные сценарии работы реализованы
- ✅ Полная ролевая модель сохранена

---

# Сервис 1: User & Auth Service

**Тип архитектуры** - Modular Monolith + Clean Architecture

**Тип:** Независимый микросервис с встроенным API Gateway  
**Порт:** 8080  
**База данных:** Схема `user_management`

**Для чего нужен:** 
- Единая точка входа для всех внешних запросов (API Gateway)
- Регистрация, авторизация и управление пользователями
- Аудит критических действий системы

**Взаимодействие между модулями:**
- Auth → User (прямые вызовы)
- API Gateway → Auth (проверка токенов)
- API Gateway, Auth → Audit (Логирование всех действий)

**Технологии:** Spring Boot 3.2+, Spring Security, JWT, Spring Modulith

## 1.1 Token Managment

**Для чего нужен:** Маршрутизация запросов к внутренним сервисам с проверкой токенов.

**Необходимый функционал:**
- Проверка JWT токенов авторизации
- Проверка ролей и прав доступа (RBAC)
- Rate limiting (базовый)
- Возврат нормализованных ошибок

**Технологии:** Spring Cloud Gateway (встроен в User Service)

---

## 1.2 User Management

**Схема БД:** `user_management.users`

**Для чего нужен:** Управление учетными записями пользователей всех типов.

**Необходимый функционал:**
- Регистрация новых пользователей (CLIENT, сотрудники)
- Автоматическое создание UNREGISTERED_CONTACT при сдаче посылки
- Преобразование UNREGISTERED_CONTACT → CLIENT при регистрации
- Хранение и управление профилями пользователей
- Изменение ролей и статусов пользователей

**Роли:**
- UNREGISTERED_CONTACT
- CLIENT
- PVZ_OPERATOR, PVZ_ADMIN
- COURIER, DRIVER, DISPATCHER
- WAREHOUSE_OPERATOR, WAREHOUSE_ADMIN
- HR, ACCOUNTANT, SYSTEM_ADMIN

---

## 1.3 Authentication

**Схема БД:** `user_management.user_sessions`

**Для чего нужен:** Аутентификация и управление сессиями.

**Необходимый функционал:**
- Авторизация с выдачей JWT токенов
- Проверка и валидация токенов
- Управление сессиями (создание, обновление, удаление)
- Восстановление пароля через email

**Технологии:** Spring Security, JWT

---

## 1.4 Audit Logs

**Схема БД:** `user_management.audit_logs`

**Для чего нужен:** Логирование действий в системе.

**Необходимый функционал:**
- Логирование действий HR и бухгалтерии
- Хранение журналов аудита с фильтрацией
- Предоставление доступа к журналам для SYSTEM_ADMIN
- Фиксация изменений в накладных и платежах


---

# Сервис 2: Core Business Service

**Тип:** Модульный монолит  
**Порт:** 8081  
**База данных:** Схемы `waybill_service`, `rating_service`, `shared_data` (read-only)

**Для чего нужен:** Основная бизнес-логика - управление накладными, тарификация, приемка и отзывы.

**Модули внутри:**

## 2.1 Waybill Module

**Схема БД:** `waybill_service`

**Для чего нужен:** Управление жизненным циклом накладных.

**Необходимый функционал:**
- Создание черновиков накладных с присвоением штрихкода
- Редактирование черновиков до момента сдачи в ПВЗ
- Конвертация черновика в оформленную накладную
- Хранение информации о плательщике (отправитель/получатель)
- Отмена накладных и черновиков
- Просмотр истории статусов накладных

**Где используется:** Клиенты, ПВЗ операторы

---

## 2.2 Pricing Module

**Схема БД:** `shared_data.pricing_rules`

**Для чего нужен:** Расчет стоимости и сроков доставки.

**Необходимый функционал:**
- Предварительная калькуляция стоимости (черновик)
- Итоговый расчет после взвешивания в ПВЗ
- Учет дополнительных услуг (упаковка, страховка)
- Расчет сдачи при оплате наличными

**Где используется:** Waybill Module, Acceptance Module

---

## 2.3 Acceptance Module

**Схема БД:** `waybill_service`

**Для чего нужен:** Приемка посылок в ПВЗ с проверкой параметров.

**Необходимый функционал:**
- Поиск черновика по штрихкоду
- Регистрация фактического веса и габаритов
- Фотофиксация посылки (опционально)
- Добавление дополнительных услуг
- Печать ярлыков и квитанций
- Уведомление получателя (через email)

**Где используется:** ПВЗ операторы

---

## 2.4 Rating Module

**Схема БД:** `rating_service`

**Для чего нужен:** Сбор обратной связи от клиентов.

**Необходимый функционал:**
- Создание отзыва после доставки
- Оценка по 5-балльной шкале
- Хранение истории отзывов
- Просмотр отзывов (для администраторов)

**Где используется:** Клиенты

---

**Взаимодействие между модулями:**
- Waybill → Pricing (расчет стоимости)
- Acceptance → Pricing (пересчет после взвешивания)
- Acceptance → Waybill (конвертация черновика)
- Rating → Waybill (связь отзыва с накладной)

**Технологии:** Spring Boot, Spring Modulith, Spring Data JPA

---

# Сервис 3: Logistics Service

**Тип:** Модульный монолит  
**Порт:** 8082  
**База данных:** Схемы `warehouse_service`, `delivery_service`, `waybill_service` (read-only)

**Для чего нужен:** Складская логистика, доставка и базовое отслеживание.

**Модули внутри:**

## 3.1 Warehouse Module

**Схема БД:** `warehouse_service`

**Для чего нужен:** Управление складскими операциями.

**Необходимый функционал:**
- Регистрация поступления посылок на склад (сканирование)
- Создание грузовых отгрузок (Склад→ПВЗ, Склад→Склад, ПВЗ→Склад)
- Назначение водителя и транспортного средства
- Подтверждение погрузки посылок
- Фиксация выезда и прибытия
- Разгрузка посылок в пункте назначения

**Где используется:** Складские операторы, водители

---

## 3.2 Delivery Module

**Схема БД:** `delivery_service`

**Для чего нужен:** Координация работы курьеров.

**Необходимый функционал:**
- Формирование списков доставки для курьеров
- Расчет необходимой сдачи
- Подтверждение доставки (успешная/неудачная)
- Регистрация причин неудачной доставки
- Формирование отчетов по доставкам

**Где используется:** Диспетчеры, курьеры

**Упрощения:**
- ❌ Нет GPS-отслеживания в реальном времени
- ❌ Нет автоматической оптимизации маршрутов
- ✅ Простое назначение заказов курьерам диспетчером

---

## 3.3 Tracking Module

**Схема БД:** `delivery_service.tracking_events`, `waybill_service.waybill_status_history` (read-only)

**Для чего нужен:** Отслеживание статусов заказов.

**Необходимый функционал:**
- Получение текущего статуса накладной
- История изменения статусов
- Публичный трекинг для UNREGISTERED_CONTACT (по номеру накладной + телефону)
- Базовые email-уведомления о смене статуса

**Где используется:** Клиенты, все сотрудники

**Упрощения:**
- ❌ Нет расчета ETA (ожидаемого времени доставки)
- ❌ Нет подписки на push-уведомления
- ❌ Нет карты с отслеживанием в реальном времени
- ✅ Простые email-уведомления через Spring Mail

---

**Взаимодействие между модулями:**
- Warehouse → Delivery (создание задач для курьеров)
- Tracking → Warehouse (получение статусов со склада)
- Tracking → Delivery (получение статусов доставки)

**Технологии:** Spring Boot, Spring Modulith, Spring Mail (для уведомлений)

---

# Сервис 4: Payment & HR Service

**Тип:** Модульный монолит  
**Порт:** 8083  
**База данных:** Схемы `payment_service`, `hr_service`, `shared_data` (read-only)

**Для чего нужен:** Обработка платежей, кадровый учет и бухгалтерия.

**Модули внутри:**

## 4.1 Payment Module

**Схема БД:** `payment_service`

**Для чего нужен:** Обработка платежей в системе.

**Необходимый функционал:**
- Оплата наличными (с расчетом сдачи)
- Оплата картой через терминал (CARD_TERMINAL)
- Оплата через СБП (SBP)
- Печать чеков и квитанций
- Оформление возвратов при отмене заказа
- Проверка статуса оплаты

**Где используется:** ПВЗ операторы, курьеры, бухгалтеры

**Упрощения:**
- ❌ Нет онлайн-эквайринга (CARD_ONLINE)
- ✅ Только терминальная оплата и наличные

---

## 4.2 HR Module

**Схема БД:** `hr_service.employees`, `hr_service.positions`

**Для чего нужен:** Базовый кадровый учет.

**Необходимый функционал:**
- Создание карточек сотрудников
- Назначение должностей (с привязкой к региональным окладам)
- Изменение должностей и статусов
- Оформление увольнений
- Просмотр кадровой информации
- Доступ к журналам аудита действий HR

**Где используется:** HR специалисты

**Упрощения:**
- ❌ Нет управления отпусками и больничными
- ❌ Нет оценки эффективности
- ✅ Только базовые CRUD операции с сотрудниками

---

## 4.3 Accounting Module

**Схема БД:** `hr_service.employee_payments`, `payment_service` (read-only)

**Для чего нужен:** Базовый бухгалтерский учет.

**Необходимый функционал:**
- Формирование расчетных ведомостей для сотрудников
- Расчет зарплаты с учетом опыта (через SQL-функцию)
- Выплаты курьерам и водителям
- Базовые финансовые отчеты
- Сверка кассовых смен ПВЗ
- Кассовые корректировки при возвратах

**Где используется:** Бухгалтеры

**Упрощения:**
- ❌ Нет интеграции с 1С
- ❌ Нет налоговой отчетности
- ❌ Нет детальной аналитики
- ✅ Простые расчеты и ведомости

---

**Взаимодействие между модулями:**
- Payment → HR (данные для сверки выплат курьерам)
- HR → Accounting (данные сотрудников для зарплаты)
- Accounting → Payment (сверка кассовых операций)

**Технологии:** Spring Boot, Spring Modulith, Jasper Reports (опционально)

---

# Таблица маппинга: Сервисы → Схемы БД (базовая версия)

| Сервис | Схемы БД (доступ) | Тип доступа |
|--------|-------------------|-------------|
| User & Auth Service | user_management | Read/Write |
| Core Business Service | waybill_service, rating_service | Read/Write |
| Core Business Service | shared_data | Read-only |
| Logistics Service | warehouse_service, delivery_service | Read/Write |
| Logistics Service | waybill_service | Read-only |
| Payment & HR Service | payment_service, hr_service | Read/Write |
| Payment & HR Service | shared_data | Read-only |

---

# Технологический стек (базовая версия)

- **Framework:** Spring Boot 3.2+, Spring Modulith
- **База данных:** PostgreSQL 15+ (одна БД, 7 схем)
- **Безопасность:** Spring Security, JWT
- **API Gateway:** Spring Cloud Gateway (встроен в User Service)
- **Email:** Spring Mail (простые уведомления)
- **Контейнеризация:** Docker, Docker Compose
- **Отчеты:** Jasper Reports (опционально)

**Исключено из стека:**
- ❌ RabbitMQ/Kafka (нет асинхронной коммуникации)
- ❌ Redis (нет кэширования)
- ❌ ELK Stack (нет централизованного логирования)
- ❌ Prometheus/Grafana (нет мониторинга)

---

# Межсервисная коммуникация (базовая версия)

**Все взаимодействия синхронные через REST API:**

```
User & Auth Service (8080)
    ↓ JWT validation
Core Business Service (8081)
    ↓ GET /api/waybill/{id}
Logistics Service (8082)
    ↓ GET /api/payment/status/{waybillId}
Payment & HR Service (8083)
```

**Примеры вызовов:**

1. **Создание накладной:**
   - Client → User Service → Core Business (Waybill Module)
   - Waybill Module → Pricing Module (внутренний вызов)

2. **Приемка посылки в ПВЗ:**
   - PVZ Operator → User Service → Core Business (Acceptance Module)
   - Acceptance Module → Payment Service (REST: проверка оплаты)
   - Acceptance Module → отправка email через Spring Mail

3. **Доставка курьером:**
   - Courier → User Service → Logistics Service (Delivery Module)
   - Delivery Module → Core Business (REST: обновление статуса накладной)
   - Delivery Module → Payment Service (REST: подтверждение оплаты)

**Обработка ошибок:**
- Retry механизм на уровне RestTemplate
- Circuit Breaker (Resilience4j) для защиты от падения сервисов
- Fallback ответы при недоступности сервиса

---

# Развертывание (docker-compose.yml)

```yaml
version: '3.8'

services:
  postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: logistics
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: password
    ports:
      - "5432:5432"

  user-auth-service:
    build: ./user-auth-service
    ports:
      - "8080:8080"
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/logistics
    depends_on:
      - postgres

  core-business-service:
    build: ./core-business-service
    ports:
      - "8081:8081"
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/logistics
      USER_SERVICE_URL: http://user-auth-service:8080
    depends_on:
      - postgres
      - user-auth-service

  logistics-service:
    build: ./logistics-service
    ports:
      - "8082:8082"
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/logistics
      USER_SERVICE_URL: http://user-auth-service:8080
      CORE_BUSINESS_URL: http://core-business-service:8081
    depends_on:
      - postgres
      - user-auth-service

  payment-hr-service:
    build: ./payment-hr-service
    ports:
      - "8083:8083"
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/logistics
      USER_SERVICE_URL: http://user-auth-service:8080
    depends_on:
      - postgres
      - user-auth-service
```

---

# Что реализовано в базовой версии

## ✅ Полностью реализовано:

1. **Регистрация и авторизация** (все роли)
2. **Создание и управление накладными** (черновики, оформление)
3. **Приемка посылок в ПВЗ** (взвешивание, фотофиксация)
4. **Складская логистика** (поступление, отгрузка, грузоперевозки)
5. **Доставка курьерами** (назначение, подтверждение)
6. **Платежи** (наличные, карта, СБП, возвраты)
7. **Базовый трекинг** (статусы, история, публичный доступ)
8. **Кадровый учет** (сотрудники, должности)
9. **Бухгалтерия** (расчет зарплат, выплаты, сверки)
10. **Отзывы** (оценки и комментарии клиентов)

## ❌ Упрощено или отсутствует:

1. **GPS-отслеживание** (нет реал-тайм карты)
2. **Расчет ETA** (нет предсказания времени доставки)
3. **Централизованные уведомления** (нет Notification Service)
4. **Асинхронная коммуникация** (все синхронно через REST)
5. **Мониторинг и метрики** (нет Prometheus/Grafana)
6. **Продвинутая аналитика** (нет детальной отчетности)
7. **Онлайн-эквайринг** (только терминальная оплата)

---

# Оценка трудозатрат (базовая версия)

| Фаза | Недели | Комментарий |
|------|--------|-------------|
| Настройка инфраструктуры | 1 | docker-compose, PostgreSQL схемы |
| User & Auth Service | 2 | Регистрация, JWT, RBAC |
| Core Business Service | 4 | Waybill, Pricing, Acceptance, Rating |
| Logistics Service | 3 | Warehouse, Delivery, Tracking (упрощенный) |
| Payment & HR Service | 2 | Payment, HR, Accounting (базовый) |
| Интеграционное тестирование | 2 | Проверка взаимодействия сервисов |
| UI и документация | 2 | Базовый веб-интерфейс, README |
| **ИТОГО** | **16 недель** | **≈ 4 месяца** |

**Запас времени:** 2 месяца для багфиксинга и подготовки к защите.

**Итого на диплом:** 6 месяцев (реалистично для одного разработчика).

---
