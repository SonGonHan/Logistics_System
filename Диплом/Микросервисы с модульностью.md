#диплом
## Обзор архитектуры

Система построена по **гибридному принципу**, объединяющему преимущества микросервисной и модульной монолитной архитектур:
- **6 независимых приложений** (развертываемых сервисов)
- **14 логических модулей** внутри монолитных сервисов
- **1 база данных PostgreSQL** с 10 изолированными схемами
- Использование **Spring Modulith** для контроля границ между модулями

**Принципы:**
- Каждый модуль работает со своей схемой БД
- Модули взаимодействуют через внутренние API или события
- Возможность выделения модуля в отдельный микросервис в будущем
- Упрощенная разработка и развертывание

---

# Группа 1: Инфраструктурные сервисы

## 1. Edge Service (API Gateway)

**Тип:** Независимый микросервис  
**Порт:** 8080  
**База данных:** Не требуется (stateless)

**Для чего нужен:** Единая точка входа для всех внешних запросов с маршрутизацией к внутренним сервисам, проверкой токенов и управлением нагрузкой.

**Необходимый функционал:**
- Проверка токенов авторизации
- Маршрутизация запросов к внутренним сервисам
- Проверка ролей и прав доступа
- Агрегация данных от нескольких сервисов
- Применение rate limiting и троттлинга
- Управление версиями API (canary/blue-green deployments)
- Возврат нормализованных ошибок и fallback-ответов
- Отправка метрик и телеметрии отказов

**Где используется:** Все клиентские приложения

**Дополнительный функционал:**
- Кеширование часто запрашиваемых данных
- Трансформация форматов запросов/ответов
- A/B тестирование функциональности
- Защита от DDoS-атак
- Централизованное логирование и трассировка запросов

**Технологии:** Spring Cloud Gateway, Redis для кэша

---

## 2. User Management Service

**Тип:** Независимый микросервис  
**Порт:** 8081  
**База данных:** Схемы `user_management` (users, sessions, audit_logs)

**Для чего нужен:** Обеспечивает регистрацию, авторизацию и управление учетными записями пользователей всех типов в системе, включая аудит действий.

**Модули внутри:**
- **User Module** - управление пользователями
- **Auth Module** - аутентификация и авторизация  
- **Audit Module** - логирование критических действий

**Необходимый функционал:**

### User Module
- Регистрация новых пользователей с созданием учетной записи
- Преобразование UNREGISTERED_CONTACT в CLIENT при регистрации
- Хранение и управление профилями пользователей
- Изменение ролей и статусов пользователей

### Auth Module
- Авторизация пользователей с выдачей JWT токенов
- Проверка и валидация токенов авторизации
- Управление сессиями пользователей
- Двухфакторная аутентификация
- Восстановление пароля через email/SMS

### Audit Module
- Логирование действий HR и бухгалтерии
- Хранение журналов с фильтрацией по периоду и пользователю
- Предоставление доступа к административным журналам
- Фиксация технических событий и отказов

**Где используется:** Все приложения системы

**Взаимодействие между модулями:** 
- User → Audit (внутренние события через Spring Modulith)
- Auth → User (прямые вызовы через package API)

**Технологии:** Spring Security, JWT, Spring Modulith

---

## 3. Notification Service

**Тип:** Независимый микросервис  
**Порт:** 8082  
**База данных:** Схема `notification_service` (notification_queue, templates, subscriptions)

**Для чего нужен:** Централизованная отправка уведомлений пользователям по различным каналам.

**Необходимый функционал:**
- Управление шаблонами уведомлений
- Отправка уведомлений через email, SMS и push
- Управление очередью уведомлений с ретраями и приоритизацией
- Обработка подписок на уведомления
- Персонализация контента уведомлений

**Где используется:** Все сервисы (асинхронно через message queue)

**Дополнительный функционал:**
- Аналитика доставляемости уведомлений
- Интеграция с мессенджерами (Telegram, WhatsApp)
- Планирование отложенных уведомлений

**Технологии:** RabbitMQ/Kafka для очереди, Twilio для SMS

---

# Группа 2: Core Business Service (Модульный монолит)

**Тип:** Модульный монолит  
**Порт:** 8083  
**База данных:** Схемы `waybill_service`, `rating_service`, `shared_data` (read-only)

**Для чего нужен:** Основная бизнес-логика системы - управление накладными, тарификацией, приемкой и отзывами.

**Модули внутри:**

## 4. Waybill Module

**Схема БД:** `waybill_service`

**Для чего нужен:** Управляет жизненным циклом накладных от создания черновика до финального оформления отправки.

**Необходимый функционал:**
- Создание и сохранение черновиков накладных с присвоением ID/штрихкода
- Редактирование черновиков до момента сдачи
- Конвертация черновика в оформленную накладную
- Хранение информации о плательщике и методе оплаты
- Отмена черновиков и накладных

**Где используется:** Клиенты, ПВЗ

**Дополнительный функционал:**
- Шаблоны часто используемых накладных
- Массовое создание накладных
- Экспорт накладных в различные форматы

---

## 5. Pricing Module

**Схема БД:** `shared_data.pricing_rules`, `shared_data.service_catalog`

**Для чего нужен:** Выполняет расчет стоимости доставки и сроков на основе параметров отправления.

**Необходимый функционал:**
- Предварительная калькуляция стоимости и сроков доставки
- Пересчет стоимости после проверки фактических параметров груза
- Учет дополнительных услуг в расчете стоимости
- Расчет сдачи при оплате наличными

**Где используется:** Waybill Module, Acceptance Module

**Дополнительный функционал:**
- Динамическое ценообразование на основе загрузки
- Скидки и промокоды
- Специальные тарифы для корпоративных клиентов
- История изменения тарифов

---

## 6. Acceptance Module

**Схема БД:** `waybill_service.acceptance_records`

**Для чего нужен:** Обрабатывает процесс приемки посылок в ПВЗ с проверкой параметров груза.

**Необходимый функционал:**
- Поиск черновиков по штрихкоду/ID
- Регистрация фактического веса и габаритов груза
- Фотофиксация посылок
- Добавление дополнительных услуг и упаковки
- Печать ярлыков и квитанций

**Где используется:** ПВЗ

**Дополнительный функционал:**
- Автоматическое определение габаритов по фото
- Контроль запрещенных к перевозке вложений
- Страхование грузов

---

## 7. Rating Module

**Схема БД:** `rating_service`

**Для чего нужен:** Собирает обратную связь от клиентов о качестве обслуживания.

**Необходимый функционал:**
- Сохранение оценок и отзывов клиентов
- Хранение истории отзывов
- Предоставление интерфейса для оставления отзывов после доставки
- Аналитика качества обслуживания

**Где используется:** Клиенты, ОК

**Дополнительный функционал:**
- Автоматическая модерация отзывов
- Система реагирования на негативные отзывы
- Публичный рейтинг курьеров и ПВЗ

---

**Взаимодействие между модулями Core Business Service:**
- Waybill → Pricing (расчет стоимости)
- Acceptance → Pricing (пересчет после проверки)
- Acceptance → Waybill (обновление статуса)
- Rating → Waybill (связь отзыва с накладной)

**Технологии:** Spring Boot, Spring Modulith, Spring Data JPA

---

# Группа 3: Logistics Service (Модульный монолит)

**Тип:** Модульный монолит  
**Порт:** 8084  
**База данных:** Схемы `warehouse_service`, `delivery_service`, `shared_data` (read-only)

**Для чего нужен:** Управление складской логистикой, доставкой, геолокацией и отслеживанием посылок.

**Модули внутри:**

## 8. Warehouse Module

**Схема БД:** `warehouse_service`

**Для чего нужен:** Управляет процессами приемки, хранения и отгрузки на складах.

**Необходимый функционал:**
- Регистрация поступления посылок на склад со сканированием штрихкодов
- Создание отгрузок и формирование списков мест
- Назначение транспортных средств и водителей для отгрузки
- Назначение слотов погрузки
- Подтверждение погрузки мест
- Фиксация выезда со склада
- Мониторинг статусов загрузки и отправки

**Где используется:** Склад

**Дополнительный функционал:**
- Оптимизация размещения грузов на складе
- Инвентаризация
- Контроль сроков хранения
- Автоматическая маршрутизация перемещений

---

## 9. Delivery Module

**Схема БД:** `delivery_service.deliveries`, `delivery_service.routes`

**Для чего нужен:** Координирует работу курьеров и водителей, управляет рейсами и маршрутами.

**Необходимый функционал:**
- Формирование списков назначений и маршрутов для курьеров
- Расчет необходимой сдачи для курьеров
- Получение планов рейсов для водителей (Склад-ПВЗ/ПВЗ-Склад/Склад-Склад)
- Фиксация старта и завершения рейсов
- Обновление промежуточных статусов доставки
- Подтверждение успешной доставки
- Регистрация неудачных попыток доставки с указанием причин
- Формирование актов погрузки/разгрузки

**Где используется:** Доставка

**Дополнительный функционал:**
- Оптимизация маршрутов с учетом пробок
- Динамическое перераспределение заказов между курьерами
- Интеграция с навигационными системами
- Анализ эффективности курьеров

---

## 10. Geolocation Module

**Схема БД:** `delivery_service.geolocation_history`

**Для чего нужен:** Собирает и обрабатывает данные о местоположении курьеров и транспортных средств.

**Необходимый функционал:**
- Прием координат от курьеров с заданной периодичностью
- Хранение истории перемещений
- Фиксация геопозиций при старте рейсов
- Передача данных телеметрии рейсов
- Определение текущего местоположения курьера

**Где используется:** Delivery Module, Tracking Module, Клиенты

**Дополнительный функционал:**
- Геозоны и автоматические уведомления при входе/выходе
- Анализ отклонений от маршрута
- Расчет фактического пробега
- Тепловые карты загруженности районов

---

## 11. Tracking Module

**Схема БД:** `delivery_service.tracking_events`, `waybill_service.waybill_statuses` (чтение)

**Для чего нужен:** Отслеживает и хранит историю статусов заказов, рассчитывает ETA и управляет подписками на уведомления.

**Необходимый функционал:**
- Получение текущего статуса заказа/черновика
- Хранение истории изменения статусов
- Подписка и отписка на уведомления (email/SMS/push)
- Расчет и обновление ETA (ожидаемого времени доставки)
- Публичный трекинг для неавторизованных пользователей

**Где используется:** Клиенты, ПВЗ, Склад, Доставка, ОК

**Дополнительный функционал:**
- Интерактивная карта с отслеживанием в реальном времени
- Предиктивная аналитика задержек
- Настройка персональных правил уведомлений
- Push-уведомления о приближении курьера

---

**Взаимодействие между модулями Logistics Service:**
- Warehouse → Delivery (создание рейсов)
- Delivery → Geolocation (запись координат)
- Tracking → Geolocation (чтение позиций для ETA)
- Tracking → Delivery (получение статусов доставки)

**Технологии:** Spring Boot, Spring Modulith, PostgreSQL, Redis для кэша ETA

---

# Группа 4: Payment Service (Независимый микросервис)

## 12. Payment Service

**Тип:** Независимый микросервис  
**Порт:** 8085  
**База данных:** Схема `payment_service`

**Для чего нужен:** Обрабатывает все типы платежей в системе, включая эквайринг и наличные расчеты. Изолирован из соображений безопасности и compliance.

**Необходимый функционал:**
- Инициация платежей через эквайринг (оплата картой)
- Обработка наличных платежей с расчетом сдачи
- Проверка статуса оплаты заказов
- Фиксация факта оплаты с указанием метода
- Оформление возвратов платежей
- Печать чеков и квитанций

**Где используется:** ПВЗ, Доставка, Бухгалтеры

**Дополнительный функционал:**
- Интеграция с различными платежными системами
- Рассрочка и кредитные платежи
- Электронные чеки
- Автоматическая сверка платежей
- PCI DSS compliance

**Технологии:** Spring Boot, Stripe/PayPal API, PCI DSS сертификация

---

# Группа 5: HR & Accounting Service (Модульный монолит)

**Тип:** Модульный монолит  
**Порт:** 8086  
**База данных:** Схемы `hr_service`, `shared_data` (read-only для facilities)

**Для чего нужен:** Управление кадрами, бухгалтерским учетом и выплатами исполнителям.

**Модули внутри:**

## 13. HR Module

**Схема БД:** `hr_service.employees`, `hr_service.positions`

**Для чего нужен:** Управляет кадровым учетом сотрудников компании.

**Необходимый функционал:**
- Создание карточек сотрудников
- Изменение должностей и статусов сотрудников
- Оформление увольнений с указанием причины и даты
- Хранение кадровой информации
- Предоставление доступа к административным журналам с аудитом действий

**Где используется:** ОК

**Дополнительный функционал:**
- Управление отпусками и больничными
- Система оценки эффективности сотрудников
- Обучение и сертификация персонала
- Рекрутинг и онбординг новых сотрудников

---

## 14. Accounting Module

**Схема БД:** `hr_service.payroll`, `payment_service` (read-only для сверки)

**Для чего нужен:** Обеспечивает финансовый и бухгалтерский учет операций.

**Необходимый функционал:**
- Изменение окладов и начислений сотрудников
- Формирование расчетных ведомостей
- Выгрузка финансовых отчетов
- Сверка платежей и кассовых смен ПВЗ/курьеров
- Обработка расхождений с отправкой на модерацию администратору
- Создание кассовых корректировок при возвратах

**Где используется:** Бухгалтеры

**Дополнительный функционал:**
- Автоматическое формирование налоговой отчетности
- Интеграция с бухгалтерскими системами (1С)
- Бюджетирование и планирование
- Анализ рентабельности по направлениям

---

## 15. Payout Module

**Схема БД:** `hr_service.payouts`

**Для чего нужен:** Рассчитывает и обрабатывает выплаты курьерам и водителям.

**Необходимый функционал:**
- Расчет выплат за период для исполнителей
- Подтверждение и инициация выплат
- Проверка статусов начислений
- Оформление корректировок и удержаний по инцидентам
- Расчет метрик рейсов (время, километраж, отклонения)

**Где используется:** Бухгалтеры, Доставка

**Дополнительный функционал:**
- Различные схемы мотивации (бонусы, KPI)
- Авансовые выплаты
- Интеграция с банковскими системами для автоматических переводов
- Детализация начислений для исполнителей

---

**Взаимодействие между модулями HR & Accounting Service:**
- HR → Accounting (данные сотрудников для зарплаты)
- Accounting → Payout (формирование выплат)
- Payout → HR (получение ставок по должностям)

**Технологии:** Spring Boot, Spring Modulith, Jasper Reports

---

# Таблица маппинга: Сервисы → Схемы БД

| Сервис | Схемы БД (доступ) | Тип доступа |
|--------|-------------------|-------------|
| Edge Service | - | - |
| User Management Service | user_management | Read/Write |
| Notification Service | notification_service | Read/Write |
| Core Business Service | waybill_service, rating_service | Read/Write |
| Core Business Service | shared_data | Read-only |
| Logistics Service | warehouse_service, delivery_service | Read/Write |
| Logistics Service | shared_data, waybill_service | Read-only |
| Payment Service | payment_service | Read/Write |
| HR & Accounting Service | hr_service | Read/Write |
| HR & Accounting Service | shared_data, payment_service | Read-only |

---

# Технологический стек

- **Framework:** Spring Boot 3.2+, Spring Modulith
- **База данных:** PostgreSQL 15+ (одна БД, 10 схем)
- **Message Queue:** RabbitMQ/Kafka для асинхронной коммуникации
- **Cache:** Redis для кэширования и сессий
- **API Gateway:** Spring Cloud Gateway
- **Контейнеризация:** Docker, Docker Compose
- **Мониторинг:** Prometheus + Grafana
- **Логирование:** ELK Stack (Elasticsearch, Logstash, Kibana)
